{% extends "base.html" %}

{% block title %}Create Unlinked Arrival{% endblock %}

{% block extra_css %}
<style>
  .sticky-side {
    position: sticky;
    top: 1rem;
  }
  .table-xs td, .table-xs th {
    padding-top: .4rem;
    padding-bottom: .4rem;
  }
  #parts-queue-table tbody tr {
    cursor: pointer;
  }
  #parts-queue-table tbody tr:hover {
    background-color: #f8f9fa;
  }
  #unlinked_part_search.part-selected {
    background-color: #d1ecf1;
    border-color: #0dcaf0;
    border-width: 2px;
  }
  #unlinked_part_search.part-selected::after {
    content: " âœ“";
    color: #0dcaf0;
    font-weight: bold;
  }
  .dropdown-item:hover {
    background-color: #e7f3ff;
  }
  .dropdown-item.active {
    background-color: #0dcaf0;
    color: white;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">
            <i class="bi bi-box-arrow-in-down text-success"></i> Create Unlinked Arrival
          </h1>
          <p class="text-muted mb-0">Record a package arrival without linking to purchase orders.</p>
        </div>
        <div>
          <a href="{{ url_for('inventory.arrivals_index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Arrivals
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Part Search Section -->
    <div class="col-lg-7">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-search"></i> Search Parts</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {% include 'inventory/purchase_orders/search_bars/unlinked_part_searchbar.html' %}
            
            <div class="col-md-6">
              <label class="form-label">Quantity Received <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="part_quantity" min="0.01" step="0.01" value="1">
            </div>
            <div class="col-12">
              <label class="form-label">Arrival Notes (Optional)</label>
              <input type="text" class="form-control" id="part_arrival_notes" placeholder="Optional notes for this part arrival">
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-success" id="add-part-btn" disabled>
                <i class="bi bi-plus-circle"></i> Add to Queue
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Selected Part Display -->
      <div class="card" id="selected-part-card" style="display: none;">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0"><i class="bi bi-info-circle"></i> Selected Part</h6>
        </div>
        <div class="card-body">
          <div id="selected-part-info"></div>
        </div>
      </div>
    </div>

    <!-- Parts Queue -->
    <div class="col-lg-5">
      <div class="sticky-side">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-basket"></i> Parts Queue</h5>
            <button type="button" class="btn btn-sm btn-outline-danger" id="clear-queue-btn">
              <i class="bi bi-trash"></i> Clear All
            </button>
          </div>
          <div class="card-body">
            <div id="parts-queue-empty" class="alert alert-info">
              <i class="bi bi-info-circle"></i> No parts added yet. Search and add parts to create your arrival.
            </div>
            <div id="parts-queue-container" style="display: none;">
              <div class="table-responsive">
                <table class="table table-sm align-middle" id="parts-queue-table">
                  <thead>
                    <tr>
                      <th>Part</th>
                      <th>Qty</th>
                      <th style="width: 40px;"></th>
                    </tr>
                  </thead>
                  <tbody id="parts-queue-tbody">
                  </tbody>
                </table>
              </div>
              <div class="mt-3">
                <div class="d-flex justify-content-between">
                  <strong>Total Parts:</strong>
                  <span id="queue-total-parts">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Package Header Form -->
  <form method="POST" action="{{ url_for('inventory.create_unlinked_arrival') }}" id="arrival-form" class="mt-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-box-seam"></i> Package Information</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="package_number" class="form-label">Package Number <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="package_number" name="package_number" required>
          </div>
          <div class="col-md-6">
            <label for="tracking_number" class="form-label">Tracking Number</label>
            <input type="text" class="form-control" id="tracking_number" name="tracking_number">
          </div>
          <div class="col-md-6">
            <label for="carrier" class="form-label">Carrier</label>
            <input type="text" class="form-control" id="carrier" name="carrier" placeholder="e.g., UPS, FedEx, USPS">
          </div>
          <div class="col-md-6">
            <label for="major_location_id" class="form-label">Delivery Location <span class="text-danger">*</span></label>
            <select class="form-select" id="major_location_id" name="major_location_id" required>
              <option value="">-- Select Location --</option>
              {% for location in locations %}
              <option value="{{ location.id }}">{{ location.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="storeroom_id" class="form-label">Storeroom <span class="text-danger">*</span></label>
            <select class="form-select" id="storeroom_id" name="storeroom_id" required>
              <option value="">-- Select Storeroom --</option>
              {% for storeroom in storerooms %}
              <option value="{{ storeroom.id }}">{{ storeroom.room_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12">
            <label for="notes" class="form-label">Package Notes</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden inputs for part arrivals (populated by JavaScript) -->
    <div id="hidden-part-arrivals"></div>

    <!-- Submit Section -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="mb-0 text-muted">
              <i class="bi bi-info-circle"></i> All parts will be immediately accepted and added to inventory.
            </p>
          </div>
          <div>
            <button type="submit" class="btn btn-success btn-lg" id="submit-arrival-btn" disabled>
              <i class="bi bi-check-circle"></i> Create Arrival
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.10"></script>
<script>
// Parts queue storage
let partsQueue = [];

// Part selection handling
document.addEventListener('click', function(e) {
  if (e.target.closest('.dropdown-item[data-part-id]')) {
    e.preventDefault();
    const item = e.target.closest('.dropdown-item[data-part-id]');
    
    const partId = item.getAttribute('data-part-id');
    const partNumber = item.getAttribute('data-part-number');
    const partName = item.getAttribute('data-part-name');
    
    // Update hidden input and display
    const partIdInput = document.getElementById('unlinked_part_id');
    const searchInput = document.getElementById('unlinked_part_search');
    
    partIdInput.value = partId;
    
    // Update the search input to show selected part (part number - part name)
    searchInput.value = `${partNumber} - ${partName}`;
    searchInput.classList.add('part-selected');
    
    // Show selected part info
    const selectedPartInfo = document.getElementById('selected-part-info');
    selectedPartInfo.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
        <div>
          <strong>${partNumber}</strong> - ${partName}
        </div>
      </div>
    `;
    document.getElementById('selected-part-card').style.display = 'block';
    
    // Update add button state
    updateAddButtonState();
    
    // Hide dropdown
    const dropdown = document.getElementById('unlinked_part_dropdown');
    if (dropdown) {
      dropdown.style.display = 'none';
    }
    
    // Store part data for later use
    document.getElementById('add-part-btn').dataset.partId = partId;
    document.getElementById('add-part-btn').dataset.partNumber = partNumber;
    document.getElementById('add-part-btn').dataset.partName = partName;
  }
});

// Update add button state based on part selection
function updateAddButtonState() {
  const addBtn = document.getElementById('add-part-btn');
  const partId = document.getElementById('unlinked_part_id').value || addBtn.dataset.partId;
  
  addBtn.disabled = !partId;
}

// Clear selection when user starts typing in search field
document.addEventListener('input', function(e) {
  if (e.target && e.target.id === 'unlinked_part_search') {
    const searchInput = e.target;
    // If user is typing (not just clicking), remove selected state
    if (searchInput.value !== searchInput.dataset.selectedValue) {
      searchInput.classList.remove('part-selected');
      document.getElementById('unlinked_part_id').value = '';
      document.getElementById('selected-part-card').style.display = 'none';
      updateAddButtonState();
    }
  }
});

// Add part to queue
document.getElementById('add-part-btn').addEventListener('click', function() {
  const partId = this.dataset.partId || document.getElementById('unlinked_part_id').value;
  const partNumber = this.dataset.partNumber;
  const partName = this.dataset.partName;
  const quantity = parseFloat(document.getElementById('part_quantity').value) || 0;
  const arrivalNotes = document.getElementById('part_arrival_notes').value.trim();
  
  if (!partId || !partNumber || quantity <= 0) {
    alert('Please select a part and enter a valid quantity.');
    return;
  }
  
  // Add to queue
  partsQueue.push({
    partId: partId,
    partNumber: partNumber,
    partName: partName,
    quantity: quantity,
    arrivalNotes: arrivalNotes
  });
  
  // Update display
  updateQueueDisplay();
  
  // Reset form
  const searchInput = document.getElementById('unlinked_part_search');
  document.getElementById('unlinked_part_id').value = '';
  searchInput.value = '';
  searchInput.classList.remove('part-selected');
  document.getElementById('part_quantity').value = '1';
  document.getElementById('part_arrival_notes').value = '';
  document.getElementById('selected-part-card').style.display = 'none';
  updateAddButtonState();
});

// Remove part from queue
function removePart(index) {
  partsQueue.splice(index, 1);
  updateQueueDisplay();
}

// Clear all parts
document.getElementById('clear-queue-btn').addEventListener('click', function() {
  if (partsQueue.length > 0 && confirm('Are you sure you want to clear all parts from the queue?')) {
    partsQueue = [];
    updateQueueDisplay();
  }
});

// Update queue display
function updateQueueDisplay() {
  const tbody = document.getElementById('parts-queue-tbody');
  const emptyDiv = document.getElementById('parts-queue-empty');
  const containerDiv = document.getElementById('parts-queue-container');
  const submitBtn = document.getElementById('submit-arrival-btn');
  
  if (partsQueue.length === 0) {
    emptyDiv.style.display = 'block';
    containerDiv.style.display = 'none';
    submitBtn.disabled = true;
    return;
  }
  
  emptyDiv.style.display = 'none';
  containerDiv.style.display = 'block';
  submitBtn.disabled = false;
  
  // Build table rows
  let html = '';
  
  partsQueue.forEach((part, index) => {
    html += `
      <tr>
        <td>
          <strong>${part.partNumber}</strong>
          <div class="text-muted small">${part.partName}</div>
          ${part.arrivalNotes ? '<div class="text-info small"><i class="bi bi-sticky"></i> ' + part.arrivalNotes + '</div>' : ''}
        </td>
        <td>${part.quantity}</td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePart(${index})">
            <i class="bi bi-x"></i>
          </button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  document.getElementById('queue-total-parts').textContent = partsQueue.length;
  
  // Update hidden form inputs
  updateHiddenInputs();
}

// Update hidden form inputs for submission
function updateHiddenInputs() {
  const container = document.getElementById('hidden-part-arrivals');
  let html = '';
  
  partsQueue.forEach((part, index) => {
    html += `
      <input type="hidden" name="part_id[]" value="${part.partId}">
      <input type="hidden" name="quantity_received[]" value="${part.quantity}">
      <input type="hidden" name="arrival_notes[]" value="${part.arrivalNotes}">
    `;
  });
  
  container.innerHTML = html;
}

// Form validation before submit
document.getElementById('arrival-form').addEventListener('submit', function(e) {
  if (partsQueue.length === 0) {
    e.preventDefault();
    alert('Please add at least one part to the queue before submitting.');
    return false;
  }
  
  const packageNumber = document.getElementById('package_number').value.trim();
  const locationId = document.getElementById('major_location_id').value;
  const storeroomId = document.getElementById('storeroom_id').value;
  
  if (!packageNumber || !locationId || !storeroomId) {
    e.preventDefault();
    alert('Please fill in all required fields (Package Number, Location, and Storeroom).');
    return false;
  }
});

// Initialize HTMX
htmx.process(document.body);
</script>
{% endblock %}
