<!-- Search Results -->
<div class="mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="mb-0"><i class="bi bi-list-check"></i> Search Results</h6>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelectorAll('.po-line-check:not(:disabled)').forEach(cb => cb.checked = true)">Select all</button>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelectorAll('.po-line-check:not(:disabled)').forEach(cb => cb.checked = false)">Select none</button>
    </div>
  </div>
  {% if po_lines %}
    {% set selected_po_line_ids = selected_lines|map(attribute='id')|list %}
    <form method="POST" action="{{ url_for('inventory.create_arrival_add', **filters) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="table-responsive">
        <table class="table table-hover table-xs align-middle">
          <thead>
            <tr>
              <th style="width: 44px;"></th>
              <th>PO Line ID</th>
              <th>PO Number</th>
              <th>Part</th>
              <th>Qty Ordered</th>
              <th>Qty Received</th>
              <th>Remaining</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for line in po_lines %}
              {% set remaining = (line.quantity_ordered or 0.0) - (line.quantity_received_total or 0.0) %}
              {% set is_selected = line.id in selected_po_line_ids %}
              {% set is_disabled = remaining <= 0 or line.status in ['Complete', 'Cancelled'] or is_selected %}
              <tr class="{% if is_disabled %}table-secondary{% endif %}" {% if is_selected %}title="This PO line is already in the selected queue"{% endif %}>
                <td>
                  <input class="form-check-input po-line-check"
                         type="checkbox"
                         name="po_line_ids"
                         value="{{ line.id }}"
                         {% if is_selected %}checked{% endif %}
                         {% if is_disabled %}disabled{% endif %}>
                </td>
                <td>{{ line.id }}</td>
                <td>
                  {% if line.purchase_order %}
                    <strong>{{ line.purchase_order.po_number }}</strong>
                  {% else %}
                    PO-{{ line.purchase_order_id }}
                  {% endif %}
                </td>
                <td>
                  {% if line.part %}
                    <div><strong>{{ line.part.part_number }}</strong></div>
                    <div class="text-muted small">{{ line.part.part_name }}</div>
                  {% else %}
                    <div><strong>Part #{{ line.part_id }}</strong></div>
                  {% endif %}
                </td>
                <td>{{ line.quantity_ordered }}</td>
                <td>{{ '%.1f'|format(line.quantity_received_total or 0.0) }}</td>
                <td><strong>{{ '%.1f'|format(remaining) }}</strong></td>
                <td>
                  {% if is_selected %}
                    <span class="badge bg-success">Selected</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ line.status }}</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Add Selected to Queue
        </button>
      </div>
    </form>
  {% else %}
    <div class="alert alert-info mb-0">
      <i class="bi bi-info-circle"></i> No matching unfulfilled PO lines found.
    </div>
  {% endif %}
</div>
