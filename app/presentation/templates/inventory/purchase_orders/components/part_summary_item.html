<!-- Part Summary Item -->
<div class="col-12">
  <div class="card" 
       data-part-id="{{ row.part_id }}"
       data-min-quantity="{{ row.total_qty if not is_unlinked else 0 }}"
       data-default-unit-cost="{{ '%.2f'|format(row.default_unit_cost) }}"
       data-linked-demands='{{ linked_demands_list|tojson }}'
       {% if is_unlinked %}data-is-unlinked="true"{% endif %}>
    <div class="card-header bg-light">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <strong>{{ row.part_number }}</strong>
          <span class="text-muted small ms-2">{{ row.part_name }}</span>
          {% if is_unlinked %}
            <span class="badge bg-info ms-2">Unlinked</span>
          {% endif %}
        </h6>
        {% if is_unlinked %}
          <button type="button" 
                  class="btn btn-sm btn-outline-danger" 
                  hx-post="{{ url_for('inventory.create_po_from_part_demands_remove_unlinked', part_id=row.part_id) }}"
                  hx-target="body"
                  hx-swap="none"
                  hx-confirm="Are you sure you want to remove this unlinked part?"
                  hx-on="htmx:afterRequest: window.location.reload()"
                  title="Remove unlinked part">
            <i class="bi bi-x"></i> Remove
          </button>
        {% elif part_demands_for_part %}
          {% set clean_filters = {} %}
          {% for k, v in filters.items() %}
            {% if v and v != '' %}
              {% set _ = clean_filters.update({k: v}) %}
            {% endif %}
          {% endfor %}
          <button type="button" 
                  class="btn btn-sm btn-outline-danger" 
                  hx-post="{{ url_for('inventory.create_po_from_part_demands_remove_part', part_id=row.part_id, **clean_filters) }}"
                  hx-target="body"
                  hx-swap="none"
                  hx-confirm="Are you sure you want to remove all part demands for this part? This will remove {{ part_demands_for_part|length }} part demand(s)."
                  hx-on="htmx:afterRequest: window.location.reload()"
                  title="Remove all part demands for this part">
            <i class="bi bi-x"></i> Remove
          </button>
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Total Quantity Input -->
        <div class="col-md-3">
          <label class="form-label">Total Quantity *</label>
          <input class="form-control quantity-input" type="number" 
                 min="{{ row.total_qty if not is_unlinked else 0.01 }}" 
                 step="0.01"
                 name="quantity_part_{{ row.part_id }}" 
                 id="quantity_part_{{ row.part_id }}"
                 value="{{ row.total_qty }}" 
                 data-min-qty="{{ row.total_qty if not is_unlinked else 0.01 }}"
                 data-part-id="{{ row.part_id }}"
                 required {% if not selected_demands and not is_unlinked %}disabled{% endif %}>
          <small class="text-muted" data-min-quantity-help>
            {% if is_unlinked %}Min: 0.01{% else %}Min: {{ row.total_qty }}{% endif %}
          </small>
        </div>
        
        <!-- Unit Cost Input -->
        <div class="col-md-3">
          <label class="form-label">Unit Cost *</label>
          <input class="form-control unit-cost-input" type="number" min="0" step="0.01" 
                 name="unit_cost_part_{{ row.part_id }}" 
                 id="unit_cost_part_{{ row.part_id }}"
                 value="{{ '%.2f'|format(row.default_unit_cost) }}" 
                 data-part-id="{{ row.part_id }}"
                 required {% if not selected_demands and not is_unlinked %}disabled{% endif %}>
        </div>
        
        <!-- Total Cost Display -->
        <div class="col-md-3">
          <label class="form-label">Total Cost</label>
          <div id="total_cost_part_{{ row.part_id }}" 
               data-total-cost
               class="form-control bg-light" 
               style="padding: 0.375rem 0.75rem;">
            ${{ "%.2f"|format(row.total_qty * row.default_unit_cost) }}
          </div>
        </div>
        
        <!-- Confirm Checkbox -->
        <div class="col-md-3">
          <label class="form-label">Confirm Price *</label>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="confirm_price_part_{{ row.part_id }}" required {% if not selected_demands and not is_unlinked %}disabled{% endif %}>
            <label class="form-check-label">I confirm this price</label>
          </div>
        </div>
        
        <!-- Part Demands Summary -->
        <div class="col-md-12">
          <hr class="my-2">
          {% if is_unlinked %}
            <div class="alert alert-info mb-0">
              <i class="bi bi-info-circle"></i> This is an unlinked part with no associated part demands.
            </div>
          {% elif part_demands_for_part %}
            <details>
              <summary class="text-primary fw-bold" style="cursor: pointer;">
                <i class="bi bi-list-ul"></i> View {{ part_demands_for_part|length }} Part Demand{{ 's' if part_demands_for_part|length != 1 else '' }} (Click to expand)
              </summary>
              <div class="mt-3">
                <div class="table-responsive">
                  <table class="table table-sm table-bordered table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>ID</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Maintenance Event</th>
                        <th>Asset</th>
                        <th>Location</th>
                        <th>Assigned To</th>
                        <th style="width: 80px;">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in part_demands_for_part %}
                        <tr>
                          <td>{{ d.id }}</td>
                          <td>{{ d.quantity_required }}</td>
                          <td>
                            <span class="badge 
                              {% if d.status == 'Pending Manager Approval' or d.status == 'Requested' %}bg-warning
                              {% elif d.status == 'Pending Inventory Approval' %}bg-info
                              {% elif d.status == 'Approved' or d.status == 'Issued' %}bg-success
                              {% elif d.status == 'Rejected' %}bg-danger
                              {% else %}bg-secondary{% endif %}">
                              {{ d.status }}
                            </span>
                          </td>
                          <td>
                            <span class="badge 
                              {% if d.priority == 'Critical' %}bg-danger
                              {% elif d.priority == 'High' %}bg-warning
                              {% elif d.priority == 'Medium' %}bg-info
                              {% else %}bg-secondary{% endif %}">
                              {{ d.priority }}
                            </span>
                          </td>
                          <td>
                            {% if d.action and d.action.maintenance_action_set %}
                              Event #{{ d.action.maintenance_action_set.event_id }}
                              {% if d.action.maintenance_action_set.task_name %}
                                <br><small class="text-muted">{{ d.action.maintenance_action_set.task_name }}</small>
                              {% endif %}
                            {% else %}
                              <span class="text-muted">N/A</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if d.action and d.action.maintenance_action_set and d.action.maintenance_action_set.asset_id %}
                              Asset #{{ d.action.maintenance_action_set.asset_id }}
                            {% else %}
                              <span class="text-muted">N/A</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if d.action and d.action.maintenance_action_set and d.action.maintenance_action_set.asset %}
                              {% if d.action.maintenance_action_set.asset.major_location %}
                                {{ d.action.maintenance_action_set.asset.major_location.name }}
                              {% else %}
                                <span class="text-muted">N/A</span>
                              {% endif %}
                            {% else %}
                              <span class="text-muted">N/A</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if d.action and d.action.maintenance_action_set and d.action.maintenance_action_set.assigned_user %}
                              {{ d.action.maintenance_action_set.assigned_user.username }}
                            {% else %}
                              <span class="text-muted">Unassigned</span>
                            {% endif %}
                          </td>
                          <td>
                            {% set clean_filters = {} %}
                            {% for k, v in filters.items() %}
                              {% if v and v != '' %}
                                {% set _ = clean_filters.update({k: v}) %}
                              {% endif %}
                            {% endfor %}
                            <button type="button" 
                                    class="btn btn-sm btn-outline-danger" 
                                    hx-post="{{ url_for('inventory.create_po_from_part_demands_remove', part_demand_id=d.id, **clean_filters) }}"
                                    hx-target="body"
                                    hx-swap="none"
                                    hx-confirm="Are you sure you want to remove this part demand?"
                                    hx-on="htmx:afterRequest: window.location.reload()"
                                    title="Remove this part demand">
                              <i class="bi bi-x"></i>
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </details>
          {% else %}
            <div class="alert alert-info mb-0">
              <i class="bi bi-info-circle"></i> No part demands associated with this part.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
