{% extends "base.html" %}

{% block title %}PO Linkage Portal - {{ purchase_order.po_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('inventory.index') }}">Inventory</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('inventory.purchase_orders_list') }}">Purchase Orders</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('inventory.purchase_order_view', po_id=purchase_order.id) }}">{{ purchase_order.po_number }}</a></li>
                <li class="breadcrumb-item active">Linkage Portal</li>
            </ol>
        </nav>
        
        <h2><i class="bi bi-link-45deg text-primary"></i> Purchase Order Linkage Portal</h2>
        <p class="text-muted">PO: {{ purchase_order.po_number }} | Vendor: {{ purchase_order.vendor_name }}</p>
    </div>

    <!-- Purchase Order Lines and Part Demands Section -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary bg-opacity-10">
            <h5 class="mb-0">
                <i class="bi bi-cart-check text-primary"></i> Purchase Order Lines
            </h5>
        </div>
        <div class="card-body">
            {% for line_data in lines_with_demands %}
            <!-- SECTION: PO LINE {{ loop.index }} -->
            <div class="row g-3 align-items-stretch" data-po-line-id="{{ line_data.po_line.id }}">
                <div class="col-md-6">
                    <h6 class="fw-bold mb-2"><i class="bi bi-receipt"></i> PO Line and Summary</h6>
                    <div class="card po-line-item clickable-po-line" data-part-id="{{ line_data.po_line.part.id }}" data-part-number="{{ line_data.po_line.part.part_number }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">{{ purchase_order.po_number }} - Line {{ line_data.po_line.line_number }}</h6>
                                    <small class="text-muted">Vendor: {{ purchase_order.vendor_name }}</small>
                                </div>
                                <span class="badge bg-info">{{ line_data.po_line.status }}</span>
                            </div>
                            <hr class="my-2">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Part:</small><br>
                                    <strong>{{ line_data.po_line.part.part_number }}</strong> - {{ line_data.po_line.part.part_name }}
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Quantity:</small><br>
                                    <strong>{{ line_data.po_line.quantity_ordered }} {{ line_data.po_line.part.unit_of_measure or 'units' }}</strong>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <small class="text-muted">Unit Cost:</small> <strong>${{ "%.2f"|format(line_data.po_line.unit_cost) }}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Line Total:</small> <strong>${{ "%.2f"|format(line_data.po_line.line_total) }}</strong>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <small class="text-muted">Ordered:</small> <strong class="text-success">{{ line_data.po_line.quantity_ordered }}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Allocated:</small> <strong class="text-warning allocated-qty">{{ line_data.po_line.quantity_ordered - line_data.quantity_available }}</strong>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted">Available:</small>
                                    <strong class="text-primary available-qty">{{ line_data.quantity_available }} {{ line_data.po_line.part.unit_of_measure or 'units' }}</strong>
                                    <span class="badge bg-{% if line_data.allocation_percentage >= 75 %}danger{% elif line_data.allocation_percentage >= 50 %}warning{% else %}success{% endif %} allocation-badge ms-2 availability-pct">{{ "%.1f"|format(100 - line_data.allocation_percentage) }}% Available</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">Expected Delivery:</small> <strong>{{ line_data.po_line.expected_delivery_date or 'TBD' }}</strong>
                            </div>
                            {% if line_data.po_line.notes %}
                            <div class="mt-2">
                                <small class="text-muted">Notes:</small><br>
                                <small>{{ line_data.po_line.notes }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h6 class="fw-bold mb-2"><i class="bi bi-wrench"></i> Part Demands (for this PO line)</h6>
                    <div class="card border-0">
                        <div class="list-group demands-list" data-po-line-id="{{ line_data.po_line.id }}">
                            {% if line_data.linked_demands %}
                                {% for demand in line_data.linked_demands %}
                                <div class="list-group-item part-demand-item border-success" data-demand-id="{{ demand.id }}">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="mb-1">Part Demand #{{ demand.id }}</h6>
                                            <small class="text-muted">Action: {{ demand.action.action_name if demand.action else 'N/A' }}</small>
                                        </div>
                                        <span class="badge bg-success">Linked</span>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Part:</small><br>
                                            <strong>{{ demand.part.part_number }}</strong> - {{ demand.part.part_name }}
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Required:</small><br>
                                            <strong>{{ demand.quantity_required }}</strong>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Maintenance Event:</small>
                                        <strong>{{ demand.action.maintenance_action_set.task_name if (demand.action and demand.action.maintenance_action_set) else 'N/A' }}</strong>
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-danger unlink-btn" data-demand-id="{{ demand.id }}">
                                            <i class="bi bi-unlink"></i> Unlink
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}

                            {% if not line_data.linked_demands %}
                            <div class="list-group-item">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    No linked demands for this PO line yet. Use the <span class="fw-bold">PO Linkage Tool</span> below to find and link matching demands.
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {% if not loop.last %}
            <hr class="my-4">
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="alert alert-primary mb-4" role="alert">
        <div class="d-flex align-items-start">
            <i class="bi bi-shield-check me-2"></i>
            <div>
                <div class="fw-bold">Matching rule enforced</div>
                <div class="small">
                    This section only shows Part Demands whose Part ID matches the selected PO Line Part ID.
                </div>
            </div>
        </div>
    </div>

    <!-- PO Linkage Tool Section -->
    <div class="card border-success">
        <div class="card-header bg-success bg-opacity-10">
            <h5 class="mb-0">
                <i class="bi bi-link-45deg text-success"></i> PO Linkage Tool
            </h5>
        </div>
        <div class="card-body">
            <!-- Selected PO Line (populated via JS) -->
            <div class="alert alert-light border mb-3" id="selectedPoSummary" role="status">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">Selected PO Line</div>
                        <div class="small text-muted" id="selectedPoSummaryText">
                            None selected. Click a PO line above to filter matching Part Demands.
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" id="clearSelectedPoBtn" disabled>
                        <i class="bi bi-x"></i> Clear
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="by-event-tab" data-bs-toggle="tab" data-bs-target="#by-event-pane" type="button" role="tab">
                        <i class="bi bi-calendar-event"></i> By Maintenance Event ID
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="by-part-tab" data-bs-toggle="tab" data-bs-target="#by-part-pane" type="button" role="tab">
                        <i class="bi bi-box-seam"></i> Link Part Demand By Part ID
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- By Maintenance Event Tab -->
                <div class="tab-pane fade show active" id="by-event-pane" role="tabpanel">
                    <h6 class="fw-bold mb-3"><i class="bi bi-funnel"></i> By Maintenance Event ID</h6>

                    <div class="row g-3">
                        <!-- Filters (full width) -->
                        <div class="col-12">
                            <div class="card border-0">
                                <div class="card-body p-0">
                                    <div class="row g-2">
                                        <div class="col-md-3 col-6">
                                            <label class="form-label small mb-1">Asset ID</label>
                                            <input type="number" class="form-control form-control-sm" id="filterAssetId" placeholder="e.g. 12">
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <label class="form-label small mb-1">Assigned User ID</label>
                                            <input type="number" class="form-control form-control-sm" id="filterAssignedUserId" placeholder="e.g. 3">
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <label class="form-label small mb-1">Major Location ID</label>
                                            <input type="number" class="form-control form-control-sm" id="filterMajorLocationId" placeholder="e.g. 5">
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <label class="form-label small mb-1">Asset Type ID</label>
                                            <input type="number" class="form-control form-control-sm" id="filterAssetTypeId" placeholder="e.g. 2">
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <label class="form-label small mb-1">Make</label>
                                            <input type="text" class="form-control form-control-sm" id="filterMake" placeholder="e.g. Toyota">
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <label class="form-label small mb-1">Model</label>
                                            <input type="text" class="form-control form-control-sm" id="filterModel" placeholder="e.g. Corolla">
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <label class="form-label small mb-1">Created From</label>
                                            <input type="datetime-local" class="form-control form-control-sm" id="filterCreatedFrom">
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <label class="form-label small mb-1">Created To</label>
                                            <input type="datetime-local" class="form-control form-control-sm" id="filterCreatedTo">
                                        </div>
                                        <div class="col-12 d-flex gap-2 mt-1">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" id="clearEventFiltersBtn">
                                                <i class="bi bi-x-circle"></i> Clear filters
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" type="button" id="applyEventFiltersBtn">
                                                <i class="bi bi-arrow-repeat"></i> Apply
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Side-by-side lists -->
                        <div class="col-md-6">
                            <label class="form-label fw-bold">List of Maintenance Events</label>
                            <div class="list-group" style="max-height: 400px; overflow-y: auto;" id="maintenance-events-list">
                                <div class="list-group-item">
                                    <p class="text-muted mb-0"><i class="bi bi-arrow-up"></i> Select a PO line above to load matching maintenance events</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Part Demands from Selected Event</label>
                            <div class="list-group" style="max-height: 400px; overflow-y: auto;" id="event-demands-list">
                                <div class="list-group-item">
                                    <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> Select a maintenance event to view its part demands</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- By Part ID Tab -->
                <div class="tab-pane fade" id="by-part-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-md-12">
                            <h6 class="fw-bold mb-3"><i class="bi bi-box-seam"></i> All Unlinked Demands for Selected Part</h6>
                            <div class="alert alert-info" role="alert">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <div>
                                        <div class="small">
                                            Current Part: <span class="fw-bold" id="selectedPartIdText">None selected</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h6 class="fw-bold mb-3">Unlinked Part Demands</h6>
                            <div class="list-group" style="max-height: 400px; overflow-y: auto;" id="part-demands-list">
                                <div class="list-group-item">
                                    <p class="text-muted mb-0"><i class="bi bi-arrow-up"></i> Select a PO line above to view unlinked demands for that part</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="linkToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Link Status</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="linkToastBody"></div>
    </div>
</div>

<style>
    .clickable-po-line {
        cursor: pointer;
        transition: all 0.2s;
    }
    .clickable-po-line:hover {
        background-color: #e9ecef;
    }
    .clickable-po-line.selected-item {
        background-color: #cfe2ff !important;
        border-color: #0d6efd !important;
    }
    .allocation-badge {
        font-size: 0.75rem;
    }
</style>

<script>
    const poId = {{ purchase_order.id }};
    let selectedPoLineId = null;
    let selectedPartId = null;
    let selectedPartNumber = null;
    let currentEvents = [];
    
    // Toast helper
    function showToast(message, isSuccess = true) {
        const toast = new bootstrap.Toast(document.getElementById('linkToast'));
        const toastBody = document.getElementById('linkToastBody');
        toastBody.textContent = message;
        toastBody.className = `toast-body text-${isSuccess ? 'success' : 'danger'}`;
        toast.show();
    }
    
    // Update selected PO summary
    function updateSelectedPoSummary() {
        const textEl = document.getElementById('selectedPoSummaryText');
        const clearBtn = document.getElementById('clearSelectedPoBtn');
        
        if (!selectedPoLineId || !selectedPartId) {
            textEl.textContent = 'None selected. Click a PO line above to filter matching Part Demands.';
            clearBtn.disabled = true;
            return;
        }
        
        textEl.textContent = `Part: ${selectedPartNumber || selectedPartId}`;
        clearBtn.disabled = false;
    }
    
    // Load maintenance events for selected part
    function buildEventsQueryParams() {
        const params = new URLSearchParams();
        if (selectedPartId) params.set('part_id', selectedPartId);

        const assetId = document.getElementById('filterAssetId')?.value;
        const assignedUserId = document.getElementById('filterAssignedUserId')?.value;
        const majorLocationId = document.getElementById('filterMajorLocationId')?.value;
        const assetTypeId = document.getElementById('filterAssetTypeId')?.value;
        const make = document.getElementById('filterMake')?.value;
        const model = document.getElementById('filterModel')?.value;
        const createdFrom = document.getElementById('filterCreatedFrom')?.value;
        const createdTo = document.getElementById('filterCreatedTo')?.value;

        if (assetId) params.set('asset_id', assetId);
        if (assignedUserId) params.set('assigned_user_id', assignedUserId);
        if (majorLocationId) params.set('major_location_id', majorLocationId);
        if (assetTypeId) params.set('asset_type_id', assetTypeId);
        if (make) params.set('make', make);
        if (model) params.set('model', model);
        if (createdFrom) params.set('created_from', createdFrom);
        if (createdTo) params.set('created_to', createdTo);

        return params;
    }

    function loadMaintenanceEvents() {
        const eventsList = document.getElementById('maintenance-events-list');
        const demandsList = document.getElementById('event-demands-list');
        
        if (!selectedPartId) {
            eventsList.innerHTML = '<div class="list-group-item"><p class="text-muted mb-0"><i class="bi bi-arrow-up"></i> Select a PO line above to load matching maintenance events</p></div>';
            demandsList.innerHTML = '<div class="list-group-item"><p class="text-muted mb-0"><i class="bi bi-info-circle"></i> Select a maintenance event to view its part demands</p></div>';
            return;
        }
        
        eventsList.innerHTML = '<div class="list-group-item"><p class="text-muted mb-0"><i class="bi bi-hourglass-split"></i> Loading...</p></div>';

        const params = buildEventsQueryParams();
        fetch(`/inventory/purchase-orders/${poId}/link/api/events?${params.toString()}`)
            .then(r => r.json())
            .then(events => {
                currentEvents = events;
                
                if (events.length === 0) {
                    eventsList.innerHTML = '<div class="list-group-item"><p class="text-muted mb-0">No maintenance events with unlinked demands for this part.</p></div>';
                    return;
                }
                
                let html = '';
                events.forEach(ev => {
                    html += `
                        <a href="#" class="list-group-item list-group-item-action event-item" data-event-id="${ev.event_id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${ev.task_name}</h6>
                                    <small class="text-muted">Asset: ${ev.asset_name || 'N/A'}</small><br>
                                    <small class="text-muted">Start: ${ev.planned_start || 'TBD'}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-warning">${ev.status}</span><br>
                                    <small class="text-muted">${ev.demands.length} demands</small>
                                </div>
                            </div>
                        </a>
                    `;
                });
                
                eventsList.innerHTML = html;
                
                // Add click handlers
                document.querySelectorAll('.event-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const eventId = parseInt(this.dataset.eventId);
                        loadEventDemands(eventId);
                    });
                });
            })
            .catch(err => {
                console.error('Failed to load events:', err);
                eventsList.innerHTML = '<div class="list-group-item"><p class="text-danger mb-0">Error loading events</p></div>';
            });
    }
    
    // Load demands for selected event
    function loadEventDemands(eventId) {
        const demandsList = document.getElementById('event-demands-list');
        const event = currentEvents.find(e => e.event_id === eventId);
        
        if (!event || event.demands.length === 0) {
            demandsList.innerHTML = '<div class="list-group-item"><p class="text-muted mb-0">No demands found for this event</p></div>';
            return;
        }
        
        let html = '';
        event.demands.forEach(d => {
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${d.part_number} - ${d.part_name}</h6>
                            <small class="text-muted">Action: ${d.action_name}</small><br>
                            <small class="text-muted">Required: ${d.quantity_required}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${d.status === 'Approved' ? 'warning' : 'secondary'}">${d.status}</span><br>
                            <span class="badge bg-info">${d.priority}</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-success tool-link-btn" data-demand-id="${d.id}" data-qty="${d.quantity_required}">
                            <i class="bi bi-link-45deg"></i> Link to selected PO line
                        </button>
                    </div>
                </div>
            `;
        });
        
        demandsList.innerHTML = html;
        
        // Add click handlers
        document.querySelectorAll('.tool-link-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!selectedPoLineId) {
                    showToast('Please select a PO line first', false);
                    return;
                }
                linkDemandToPoLine(selectedPoLineId, parseInt(this.dataset.demandId));
            });
        });
    }
    
    // Load all demands for selected part (tab 2)
    function loadPartDemands() {
        const demandsList = document.getElementById('part-demands-list');
        const partTextEl = document.getElementById('selectedPartIdText');
        
        if (!selectedPartId) {
            demandsList.innerHTML = '<div class="list-group-item"><p class="text-muted mb-0"><i class="bi bi-arrow-up"></i> Select a PO line above to view unlinked demands for that part</p></div>';
            partTextEl.textContent = 'None selected';
            return;
        }
        
        partTextEl.textContent = selectedPartNumber || selectedPartId;
        demandsList.innerHTML = '<div class="list-group-item"><p class="text-muted mb-0"><i class="bi bi-hourglass-split"></i> Loading...</p></div>';

        const params = buildEventsQueryParams();
        fetch(`/inventory/purchase-orders/${poId}/link/api/events?${params.toString()}`)
            .then(r => r.json())
            .then(events => {
                const allDemands = [];
                events.forEach(ev => {
                    ev.demands.forEach(d => {
                        d.event_name = ev.task_name;
                        allDemands.push(d);
                    });
                });
                
                if (allDemands.length === 0) {
                    demandsList.innerHTML = '<div class="list-group-item"><p class="text-muted mb-0">No unlinked demands for this part.</p></div>';
                    return;
                }
                
                let html = '';
                allDemands.forEach(d => {
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">Demand #${d.id} - ${d.event_name}</h6>
                                    <small class="text-muted">Action: ${d.action_name}</small><br>
                                    <small class="text-muted">Required: ${d.quantity_required}</small>
                                </div>
                                <span class="badge bg-${d.status === 'Approved' ? 'warning' : 'secondary'}">${d.status}</span>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-success tool-link-btn" data-demand-id="${d.id}">
                                    <i class="bi bi-link-45deg"></i> Link to selected PO line
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                demandsList.innerHTML = html;
                
                // Add click handlers
                document.querySelectorAll('.tool-link-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (!selectedPoLineId) {
                            showToast('Please select a PO line first', false);
                            return;
                        }
                        linkDemandToPoLine(selectedPoLineId, parseInt(this.dataset.demandId));
                    });
                });
            })
            .catch(err => {
                console.error('Failed to load demands:', err);
                demandsList.innerHTML = '<div class="list-group-item"><p class="text-danger mb-0">Error loading demands</p></div>';
            });
    }
    
    // Link demand to PO line
    function linkDemandToPoLine(poLineId, demandId) {
        fetch(`/inventory/purchase-orders/${poId}/link/api/link`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({po_line_id: poLineId, part_demand_id: demandId})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, true);
                // Reload page to reflect changes
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, false);
            }
        })
        .catch(err => {
            console.error('Link failed:', err);
            showToast('Error linking demand', false);
        });
    }
    
    // Unlink demand
    function unlinkDemand(demandId) {
        if (!confirm('Are you sure you want to unlink this demand?')) return;
        
        fetch(`/inventory/purchase-orders/${poId}/link/api/unlink`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({part_demand_id: demandId})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, true);
                // Reload page to reflect changes
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, false);
            }
        })
        .catch(err => {
            console.error('Unlink failed:', err);
            showToast('Error unlinking demand', false);
        });
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Filters
        document.getElementById('applyEventFiltersBtn')?.addEventListener('click', function() {
            loadMaintenanceEvents();
            loadPartDemands();
        });

        document.getElementById('clearEventFiltersBtn')?.addEventListener('click', function() {
            const ids = [
                'filterAssetId',
                'filterAssignedUserId',
                'filterMajorLocationId',
                'filterAssetTypeId',
                'filterMake',
                'filterModel',
                'filterCreatedFrom',
                'filterCreatedTo'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            loadMaintenanceEvents();
            loadPartDemands();
        });

        // PO line selection
        document.querySelectorAll('.clickable-po-line').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.clickable-po-line').forEach(i => i.classList.remove('selected-item'));
                this.classList.add('selected-item');
                
                selectedPoLineId = parseInt(this.closest('[data-po-line-id]').dataset.poLineId);
                selectedPartId = parseInt(this.dataset.partId);
                selectedPartNumber = this.dataset.partNumber;
                
                updateSelectedPoSummary();
                loadMaintenanceEvents();
                loadPartDemands();
            });
        });
        
        // Clear selection
        document.getElementById('clearSelectedPoBtn').addEventListener('click', function() {
            document.querySelectorAll('.clickable-po-line').forEach(i => i.classList.remove('selected-item'));
            selectedPoLineId = null;
            selectedPartId = null;
            selectedPartNumber = null;
            
            updateSelectedPoSummary();
            loadMaintenanceEvents();
            loadPartDemands();
            
            document.getElementById('event-demands-list').innerHTML = '<div class="list-group-item"><p class="text-muted mb-0"><i class="bi bi-info-circle"></i> Select a maintenance event to view its part demands</p></div>';
        });
        
        // Link buttons in PO line sections
        document.querySelectorAll('.link-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const poLineId = parseInt(this.dataset.poLineId);
                const demandId = parseInt(this.dataset.demandId);
                linkDemandToPoLine(poLineId, demandId);
            });
        });
        
        // Unlink buttons
        document.querySelectorAll('.unlink-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const demandId = parseInt(this.dataset.demandId);
                unlinkDemand(demandId);
            });
        });
        
        updateSelectedPoSummary();
    });
</script>
{% endblock %}

