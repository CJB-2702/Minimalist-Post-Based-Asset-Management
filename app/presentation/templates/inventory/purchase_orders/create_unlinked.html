{% extends "base.html" %}

{% block title %}Create Unlinked Purchase Order{% endblock %}

{% block extra_css %}
<style>
  .sticky-side {
    position: sticky;
    top: 1rem;
  }
  .table-xs td, .table-xs th {
    padding-top: .4rem;
    padding-bottom: .4rem;
  }
  #parts-queue-table tbody tr {
    cursor: pointer;
  }
  #parts-queue-table tbody tr:hover {
    background-color: #f8f9fa;
  }
  #unlinked_part_search.part-selected {
    background-color: #d1ecf1;
    border-color: #0dcaf0;
    border-width: 2px;
  }
  #unlinked_part_search.part-selected::after {
    content: " âœ“";
    color: #0dcaf0;
    font-weight: bold;
  }
  .dropdown-item:hover {
    background-color: #e7f3ff;
  }
  .dropdown-item.active {
    background-color: #0dcaf0;
    color: white;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">
            <i class="bi bi-cart-plus text-primary"></i> Create Unlinked Purchase Order
          </h1>
          <p class="text-muted mb-0">Create a purchase order without linking to part demands or maintenance events.</p>
        </div>
        <div>
          <a href="{{ url_for('inventory.purchase_orders_index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Purchase Orders
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Part Search Section -->
    <div class="col-lg-7">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-search"></i> Search Parts</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {% include 'inventory/purchase_orders/search_bars/unlinked_part_searchbar.html' %}
            
            <div class="col-md-3">
              <label class="form-label">Quantity</label>
              <input type="number" class="form-control" id="part_quantity" min="1" step="1" value="1">
            </div>
            <div class="col-md-3">
              <label class="form-label">Unit Cost</label>
              <input type="number" class="form-control" id="part_unit_cost" min="0" step="0.01" value="0.00">
            </div>
            <div class="col-12">
              <label class="form-label">Line Notes (Optional)</label>
              <input type="text" class="form-control" id="part_line_notes" placeholder="Optional notes for this line item">
            </div>
            <div class="col-12">
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="price_verified" required>
                <label class="form-check-label" for="price_verified">
                  <strong>Price Verified</strong> <span class="text-danger">*</span>
                  <small class="text-muted d-block">I have reviewed and confirmed the unit cost is correct</small>
                </label>
              </div>
              <button type="button" class="btn btn-primary" id="add-part-btn" disabled>
                <i class="bi bi-plus-circle"></i> Add to Queue
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Selected Part Display -->
      <div class="card" id="selected-part-card" style="display: none;">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0"><i class="bi bi-info-circle"></i> Selected Part</h6>
        </div>
        <div class="card-body">
          <div id="selected-part-info"></div>
        </div>
      </div>
    </div>

    <!-- Parts Queue -->
    <div class="col-lg-5">
      <div class="sticky-side">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-basket"></i> Parts Queue</h5>
            <button type="button" class="btn btn-sm btn-outline-danger" id="clear-queue-btn">
              <i class="bi bi-trash"></i> Clear All
            </button>
          </div>
          <div class="card-body">
            <div id="parts-queue-empty" class="alert alert-info">
              <i class="bi bi-info-circle"></i> No parts added yet. Search and add parts to create your purchase order.
            </div>
            <div id="parts-queue-container" style="display: none;">
              <div class="table-responsive">
                <table class="table table-sm align-middle" id="parts-queue-table">
                  <thead>
                    <tr>
                      <th>Part</th>
                      <th>Qty</th>
                      <th>Cost</th>
                      <th style="width: 40px;"></th>
                    </tr>
                  </thead>
                  <tbody id="parts-queue-tbody">
                  </tbody>
                </table>
              </div>
              <div class="mt-3">
                <div class="d-flex justify-content-between">
                  <strong>Total Lines:</strong>
                  <span id="queue-total-lines">0</span>
                </div>
                <div class="d-flex justify-content-between">
                  <strong>Estimated Total:</strong>
                  <span id="queue-estimated-total">$0.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PO Header Form -->
  <form method="POST" action="{{ url_for('inventory.create_unlinked_purchase_order') }}" id="po-form" class="mt-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-receipt"></i> Purchase Order Header</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="vendor_name" class="form-label">Vendor Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="vendor_name" name="vendor_name" required>
          </div>
          <div class="col-md-6">
            <label for="vendor_contact" class="form-label">Vendor Contact</label>
            <input type="text" class="form-control" id="vendor_contact" name="vendor_contact">
          </div>
          <div class="col-md-6">
            <label for="location_id" class="form-label">Delivery Location <span class="text-danger">*</span></label>
            <select class="form-select" id="location_id" name="location_id" required>
              <option value="">-- Select Location --</option>
              {% for location in locations %}
              <option value="{{ location.id }}">{{ location.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="storeroom_id" class="form-label">Storeroom (Optional)</label>
            <select class="form-select" id="storeroom_id" name="storeroom_id">
              <option value="">-- Optional --</option>
              {% for storeroom in storerooms %}
              <option value="{{ storeroom.id }}">{{ storeroom.room_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label for="expected_delivery_date" class="form-label">Expected Delivery Date</label>
            <input type="date" class="form-control" id="expected_delivery_date" name="expected_delivery_date">
          </div>
          <div class="col-md-4">
            <label for="shipping_cost" class="form-label">Shipping Cost</label>
            <input type="number" class="form-control" id="shipping_cost" name="shipping_cost" 
                   step="0.01" min="0" value="0.00">
          </div>
          <div class="col-md-4">
            <label for="tax_amount" class="form-label">Tax Amount</label>
            <input type="number" class="form-control" id="tax_amount" name="tax_amount" 
                   step="0.01" min="0" value="0.00">
          </div>
          <div class="col-12">
            <label for="notes" class="form-label">Notes</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden inputs for line items (populated by JavaScript) -->
    <div id="hidden-line-items"></div>

    <!-- Submit Section -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="mb-0 text-muted">
              <i class="bi bi-info-circle"></i> Ensure all parts and header information are correct before submitting.
            </p>
          </div>
          <div>
            <button type="submit" class="btn btn-success btn-lg" id="submit-po-btn" disabled>
              <i class="bi bi-check-circle"></i> Create Purchase Order
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.10"></script>
<script>
// Parts queue storage
let partsQueue = [];

// Part selection handling
document.addEventListener('click', function(e) {
  if (e.target.closest('.dropdown-item[data-part-id]')) {
    e.preventDefault();
    const item = e.target.closest('.dropdown-item[data-part-id]');
    
    const partId = item.getAttribute('data-part-id');
    const partNumber = item.getAttribute('data-part-number');
    const partName = item.getAttribute('data-part-name');
    const lastCost = parseFloat(item.getAttribute('data-last-cost')) || 0;
    
    // Update hidden input and display
    const partIdInput = document.getElementById('unlinked_part_id');
    const searchInput = document.getElementById('unlinked_part_search');
    
    partIdInput.value = partId;
    document.getElementById('part_unit_cost').value = lastCost.toFixed(2);
    
    // Update the search input to show selected part (part number - part name)
    searchInput.value = `${partNumber} - ${partName}`;
    searchInput.classList.add('part-selected');
    
    // Show selected part info
    const selectedPartInfo = document.getElementById('selected-part-info');
    selectedPartInfo.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
        <div>
          <strong>${partNumber}</strong> - ${partName}
          <br><small class="text-muted">Last Unit Cost: $${lastCost.toFixed(2)}</small>
        </div>
      </div>
    `;
    document.getElementById('selected-part-card').style.display = 'block';
    
    // Reset price verified checkbox when new part is selected
    document.getElementById('price_verified').checked = false;
    
    // Update add button state based on checkbox
    updateAddButtonState();
    
    // Hide dropdown
    const dropdown = document.getElementById('unlinked_part_dropdown');
    if (dropdown) {
      dropdown.style.display = 'none';
    }
    
    // Store part data for later use
    document.getElementById('add-part-btn').dataset.partId = partId;
    document.getElementById('add-part-btn').dataset.partNumber = partNumber;
    document.getElementById('add-part-btn').dataset.partName = partName;
  }
});

// Update add button state based on checkbox and part selection
function updateAddButtonState() {
  const addBtn = document.getElementById('add-part-btn');
  const partId = document.getElementById('unlinked_part_id').value || addBtn.dataset.partId;
  const priceVerified = document.getElementById('price_verified').checked;
  
  addBtn.disabled = !partId || !priceVerified;
}

// Listen for checkbox changes
document.addEventListener('change', function(e) {
  if (e.target && e.target.id === 'price_verified') {
    updateAddButtonState();
  }
  // Uncheck price verified if unit cost changes
  if (e.target && e.target.id === 'part_unit_cost') {
    const priceVerified = document.getElementById('price_verified');
    if (priceVerified.checked) {
      priceVerified.checked = false;
      updateAddButtonState();
    }
  }
});

// Clear selection when user starts typing in search field
document.addEventListener('input', function(e) {
  if (e.target && e.target.id === 'unlinked_part_search') {
    const searchInput = e.target;
    // If user is typing (not just clicking), remove selected state
    if (searchInput.value !== searchInput.dataset.selectedValue) {
      searchInput.classList.remove('part-selected');
      document.getElementById('unlinked_part_id').value = '';
      document.getElementById('selected-part-card').style.display = 'none';
      document.getElementById('price_verified').checked = false;
      updateAddButtonState();
    }
  }
});

// Add part to queue
document.getElementById('add-part-btn').addEventListener('click', function() {
  const partId = this.dataset.partId || document.getElementById('unlinked_part_id').value;
  const partNumber = this.dataset.partNumber;
  const partName = this.dataset.partName;
  const quantity = parseFloat(document.getElementById('part_quantity').value) || 1;
  const unitCost = parseFloat(document.getElementById('part_unit_cost').value) || 0;
  const lineNotes = document.getElementById('part_line_notes').value.trim();
  const priceVerified = document.getElementById('price_verified').checked;
  
  if (!partId || !partNumber || quantity <= 0) {
    alert('Please select a part and enter a valid quantity.');
    return;
  }
  
  if (!priceVerified) {
    alert('Please verify the price by checking the "Price Verified" checkbox before adding to queue.');
    document.getElementById('price_verified').focus();
    return;
  }
  
  // Add to queue
  partsQueue.push({
    partId: partId,
    partNumber: partNumber,
    partName: partName,
    quantity: quantity,
    unitCost: unitCost,
    lineNotes: lineNotes,
    lineTotal: quantity * unitCost
  });
  
  // Update display
  updateQueueDisplay();
  
  // Reset form
  const searchInput = document.getElementById('unlinked_part_search');
  document.getElementById('unlinked_part_id').value = '';
  searchInput.value = '';
  searchInput.classList.remove('part-selected');
  document.getElementById('part_quantity').value = '1';
  document.getElementById('part_unit_cost').value = '0.00';
  document.getElementById('part_line_notes').value = '';
  document.getElementById('price_verified').checked = false;
  document.getElementById('selected-part-card').style.display = 'none';
  updateAddButtonState();
});

// Remove part from queue
function removePart(index) {
  partsQueue.splice(index, 1);
  updateQueueDisplay();
}

// Clear all parts
document.getElementById('clear-queue-btn').addEventListener('click', function() {
  if (partsQueue.length > 0 && confirm('Are you sure you want to clear all parts from the queue?')) {
    partsQueue = [];
    updateQueueDisplay();
  }
});

// Update queue display
function updateQueueDisplay() {
  const tbody = document.getElementById('parts-queue-tbody');
  const emptyDiv = document.getElementById('parts-queue-empty');
  const containerDiv = document.getElementById('parts-queue-container');
  const submitBtn = document.getElementById('submit-po-btn');
  
  if (partsQueue.length === 0) {
    emptyDiv.style.display = 'block';
    containerDiv.style.display = 'none';
    submitBtn.disabled = true;
    return;
  }
  
  emptyDiv.style.display = 'none';
  containerDiv.style.display = 'block';
  submitBtn.disabled = false;
  
  // Build table rows
  let html = '';
  let estimatedTotal = 0;
  
  partsQueue.forEach((part, index) => {
    html += `
      <tr>
        <td>
          <strong>${part.partNumber}</strong>
          <div class="text-muted small">${part.partName}</div>
          ${part.lineNotes ? '<div class="text-info small"><i class="bi bi-sticky"></i> ' + part.lineNotes + '</div>' : ''}
        </td>
        <td>${part.quantity}</td>
        <td>$${part.unitCost.toFixed(2)}</td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePart(${index})">
            <i class="bi bi-x"></i>
          </button>
        </td>
      </tr>
    `;
    estimatedTotal += part.lineTotal;
  });
  
  tbody.innerHTML = html;
  document.getElementById('queue-total-lines').textContent = partsQueue.length;
  document.getElementById('queue-estimated-total').textContent = '$' + estimatedTotal.toFixed(2);
  
  // Update hidden form inputs
  updateHiddenInputs();
}

// Update hidden form inputs for submission
function updateHiddenInputs() {
  const container = document.getElementById('hidden-line-items');
  let html = '';
  
  partsQueue.forEach((part, index) => {
    html += `
      <input type="hidden" name="part_id[]" value="${part.partId}">
      <input type="hidden" name="quantity[]" value="${part.quantity}">
      <input type="hidden" name="unit_cost[]" value="${part.unitCost}">
      <input type="hidden" name="line_notes[]" value="${part.lineNotes}">
    `;
  });
  
  container.innerHTML = html;
}

// Form validation before submit
document.getElementById('po-form').addEventListener('submit', function(e) {
  if (partsQueue.length === 0) {
    e.preventDefault();
    alert('Please add at least one part to the queue before submitting.');
    return false;
  }
  
  const vendorName = document.getElementById('vendor_name').value.trim();
  const locationId = document.getElementById('location_id').value;
  
  if (!vendorName || !locationId) {
    e.preventDefault();
    alert('Please fill in all required header fields (Vendor Name and Location).');
    return false;
  }
});

// Initialize HTMX
htmx.process(document.body);
</script>
{% endblock %}
