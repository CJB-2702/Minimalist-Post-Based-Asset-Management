{% extends "base.html" %}

{% block title %}Stocking GUI - {{ storeroom.room_name }}{% endblock %}

{% block head %}
<style>
    .storeroom-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    
    /* SVG Display Area */
    .svg-display-area {
        min-height: 400px;
        max-height: 800px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: auto;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .svg-display-area > svg,
    .svg-display-area svg,
    .svg-display-area img {
        max-width: 100%;
        max-height: 800px;
        width: auto;
        height: auto;
        display: block;
        object-fit: contain;
        flex-shrink: 0;
    }
    
    .locations-sidebar {
        max-height: 350px;
        overflow-y: auto;
    }
    
    .location-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }
    
    .location-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .location-card.selected {
        border-color: #0d6efd;
        background-color: #add8e6 !important; /* Light blue */
    }
    
    .location-card.highlighted {
        background-color: #b3d9ff !important;
        border-left-color: #0d6efd !important;
    }
    
    /* More specific selector to override .location-element */
    .location-element.location-svg-selected,
    [data-location-id].location-svg-selected,
    .location-svg-selected {
        fill: #ca3535 !important;
    }
    
    /* SVG Location Element Styling */
    .location-element {
        cursor: pointer;
        transition: fill 0.3s, stroke 0.3s;
    }
    
    .location-element:hover {
        fill: #ffcc00 !important;
        stroke: #ffaa00 !important;
    }
    
    .location-element.selected {
        fill: #ffb3ba !important; /* Pale red */
        stroke: #ff9999 !important; /* Slightly darker red for stroke */
    }
    
    /* Handle path elements that might use stroke instead of fill */
    .location-element.selected path {
        fill: #ffb3ba !important;
        stroke: #ff9999 !important;
    }
    
    /* Handle rect elements */
    .location-element.selected rect {
        fill: #ffb3ba !important;
        stroke: #ff9999 !important;
    }
    
    .selected-info {
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .selected-item {
        padding: 0.5rem;
        margin: 0.25rem 0;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-box-arrow-in-down text-primary"></i> Stocking GUI
                    </h1>
                    <p class="text-muted mb-0">{{ storeroom.room_name }} - Assign inventory to locations</p>
                </div>
                <div>
                    <a href="{{ url_for('inventory.initial_stocking', storeroom_id=storeroom.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Selection
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Items List -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-box-seam"></i> Inventory Items to Stock
                        <span class="badge bg-secondary" id="itemCount">{{ inventory_items|length }} items</span>
                    </h5>
                </div>
                <div class="card-body">
                    <form id="stockingForm">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" id="selectAllItems" title="Select All" onclick="handleSelectAllChange(this)">
                                        </th>
                                        <th>Part</th>
                                        <th class="text-end">Qty On Hand</th>
                                        <th class="text-end">Qty Allocated</th>
                                        <th class="text-end">Available</th>
                                        <th class="text-end">Avg Unit Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inv in inventory_items %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" 
                                                   class="form-check-input item-checkbox" 
                                                   name="inventory_ids" 
                                                   value="{{ inv.id }}"
                                                   data-part-number="{% if inv.part %}{{ inv.part.part_number }}{% else %}Part #{{ inv.part_id }}{% endif %}"
                                                   data-part-name="{% if inv.part %}{{ inv.part.part_name }}{% endif %}"
                                                   data-quantity="{{ inv.quantity_on_hand - inv.quantity_allocated }}"
                                                   onclick="handleItemCheckboxChange(this)">
                                        </td>
                                        <td>
                                            {% if inv.part %}
                                            <div><strong>{{ inv.part.part_number }}</strong></div>
                                            <div class="text-muted small">{{ inv.part.part_name }}</div>
                                            {% else %}
                                            <div><strong>Part #{{ inv.part_id }}</strong></div>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <strong>{{ '%.2f'|format(inv.quantity_on_hand) }}</strong>
                                        </td>
                                        <td class="text-end">{{ '%.2f'|format(inv.quantity_allocated) }}</td>
                                        <td class="text-end">
                                            <strong>{{ '%.2f'|format(inv.quantity_on_hand - inv.quantity_allocated) }}</strong>
                                        </td>
                                        <td class="text-end">
                                            {% if inv.unit_cost_avg %}
                                            ${{ '%.2f'|format(inv.unit_cost_avg) }}
                                            {% else %}
                                            <span class="text-muted">â€”</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Viewer -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h3 class="mb-0"><em>location Viewer</em></h3>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Main Content Area (Left 2/3) -->
                <div class="col-lg-8" style="overflow: hidden;">
                    <div class="svg-display-area">
                        {% if scaled_svg_content %}
                            {{ scaled_svg_content|safe }}
                        {% elif storeroom.svg_content %}
                            {{ storeroom.svg_content|safe }}
                        {% else %}
                            <div class="text-muted text-center">
                                <p><em>No layout SVG uploaded yet</em></p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Sidebar (Right 1/3) -->
                <div class="col-lg-4">
                    <h4 class="mb-3"><em>locations</em></h4>
                    <div class="locations-sidebar">
                        {% if locations %}
                            <div class="row g-2">
                                {% for location in locations %}
                                <div class="col-6">
                                    <div class="card location-card"
                                         id="locations-card-{{ location.id }}"
                                         data-location-id="{{ location.id }}"
                                         data-location-name="{{ location.display_name or location.location }}"
                                         onclick="locationSelected({{ location.id }})">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">
                                                        {{ location.display_name or location.location }}
                                                    </h6>
                                                    {% if location.location != location.display_name %}
                                                    <p class="text-muted small mb-1">ID: {{ location.location }}</p>
                                                    {% endif %}
                                                    <div class="small text-muted">
                                                        <i class="bi bi-grid-3x3-gap"></i> {{ location.bin_count }} bin{{ 's' if location.bin_count != 1 else '' }}
                                                    </div>
                                                </div>
                                                <span class="badge bg-info">ID: {{ location.id }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-3"><em>No locations found</em></p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selection Summary and Submit -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Selection Summary</h5>
                </div>
                <div class="card-body">
                    <div class="selected-info">
                        <div class="mb-3">
                            <strong>Selected Location:</strong>
                            <span id="selectedLocationDisplay" class="text-muted">None</span>
                        </div>
                        <div class="mb-3">
                            <strong>Selected Items:</strong>
                            <div id="selectedItemsDisplay" class="mt-2">
                                <span class="text-muted">No items selected</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" 
                                    class="btn btn-primary btn-lg" 
                                    id="submitMovementBtn" 
                                    onclick="submitMovement()"
                                    disabled>
                                <i class="bi bi-check-circle"></i> Submit Movement
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedLocationId = null;
let selectedLocationName = null;
let originalInventoryIds = '';
let originalSvgElementColors = {}; // Store original colors for SVG elements by element ID

// Store original inventory IDs and SVG colors on page load
document.addEventListener('DOMContentLoaded', function() {
    originalInventoryIds = Array.from(document.querySelectorAll('.item-checkbox'))
        .map(cb => cb.value)
        .join(',');
    
    // Store original colors for all SVG location elements
    originalSvgElementColors = {};
    document.querySelectorAll('[data-location-id]').forEach(svgElement => {
        const elementId = svgElement.getAttribute('id');
        originalSvgElementColors[elementId] = {
            fill: svgElement.style.fill,
            stroke: svgElement.style.stroke 
        };
    });
    console.log(originalSvgElementColors);
    // Initial update
    updateSubmitButton();
});

function locationSelected(locationId) {
    selectedLocationId = locationId;
    selectedLocationName = document.querySelector(`.location-card[data-location-id="${locationId}"]`).getAttribute('data-location-name');
    
    // Update location display
    const locationDisplay = document.getElementById('selectedLocationDisplay');
    if (locationDisplay) {
        locationDisplay.textContent = selectedLocationName || 'None';
    }
    
    // Update visual selection - location cards (blue highlight)
    document.querySelectorAll('.location-card').forEach(card => {
        card.classList.remove('selected');
        // Reset background color
        card.style.backgroundColor = '';
        card.style.borderColor = '';
    });
    const selectedCard = document.getElementById(`locations-card-${locationId}`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
        // Set blue highlight color directly
        selectedCard.style.backgroundColor = '#add8e6';
        selectedCard.style.borderColor = '#0d6efd';
    }
    
    // Update SVG element selection (red highlight)
    document.querySelectorAll('[data-location-id]').forEach(svgElement => {
        const elementId = svgElement.getAttribute('id');
        svgElement.classList.remove('location-svg-selected');
        
        // Restore original colors from stored dictionary using element ID
        if (elementId && originalSvgElementColors[elementId]) {
            const colors = originalSvgElementColors[elementId];
            svgElement.style.fill = colors.fill || '';
            svgElement.style.stroke = colors.stroke || '';
        } else {
            // Fallback: clear styles if no stored colors
            svgElement.style.fill = '';
            svgElement.style.stroke = '';
        }
    });
    
    const selectedSvgElement = document.querySelector(`[data-location-id="${locationId}"]`);
    if (selectedSvgElement) {
        selectedSvgElement.classList.add('location-svg-selected');
        // Manually set red color
        selectedSvgElement.style.fill = '#ca3535';
        selectedSvgElement.style.stroke = '#ca3535';
        // Also set color on child elements
        selectedSvgElement.querySelectorAll('path, rect, circle, ellipse, polygon, polyline').forEach(child => {
            child.style.fill = '#ca3535';
            child.style.stroke = '#ca3535';
        });
    }
    
    updateSubmitButton();
}

// Update submit button state
function updateSubmitButton() {
    const checkedItems = document.querySelectorAll('.item-checkbox:checked');
    const submitBtn = document.getElementById('submitMovementBtn');
    
    if (selectedLocationId && checkedItems.length > 0) {
        submitBtn.disabled = false;
    } else {
        submitBtn.disabled = true;
    }
    
    updateSelectedItemsDisplay();
}

// Update selected items display
function updateSelectedItemsDisplay() {
    const checkedItems = document.querySelectorAll('.item-checkbox:checked');
    const displayDiv = document.getElementById('selectedItemsDisplay');
    
    if (checkedItems.length === 0) {
        displayDiv.innerHTML = '<span class="text-muted">No items selected</span>';
        return;
    }
    
    let html = '';
    checkedItems.forEach(checkbox => {
        const partNumber = checkbox.getAttribute('data-part-number');
        const partName = checkbox.getAttribute('data-part-name');
        const quantity = checkbox.getAttribute('data-quantity');
        
        html += `<div class="selected-item">
            <strong>${partNumber}</strong>${partName ? ' - ' + partName : ''} 
            <span class="text-muted">(Qty: ${parseFloat(quantity).toFixed(2)})</span>
        </div>`;
    });
    
    displayDiv.innerHTML = html;
}

// Handle individual item checkbox change
function handleItemCheckboxChange(checkbox) {
    const selectAll = document.getElementById('selectAllItems');
    const allChecked = document.querySelectorAll('.item-checkbox:checked').length;
    const total = document.querySelectorAll('.item-checkbox').length;
    
    selectAll.checked = allChecked === total && total > 0;
    selectAll.indeterminate = allChecked > 0 && allChecked < total;
    
    updateSubmitButton();
}

// Handle select all checkbox change
function handleSelectAllChange(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    selectAllCheckbox.indeterminate = false;
    updateSubmitButton();
}

// Submit movement
function submitMovement() {
    const submitBtn = document.getElementById('submitMovementBtn');
    const checkedItems = document.querySelectorAll('.item-checkbox:checked');
    const inventoryIds = Array.from(checkedItems).map(cb => parseInt(cb.value));
    
    if (!selectedLocationId) {
        alert('Please select a location');
        return;
    }
    
    if (inventoryIds.length === 0) {
        alert('Please select at least one item');
        return;
    }
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Submitting...';
    
    // Submit
    fetch('{{ url_for("inventory.submit_stocking_movement") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            inventory_ids: inventoryIds,
            location_id: selectedLocationId,
            bin_id: null  // For now, no bin selection
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page with remaining items (items that were NOT submitted)
            const storeroomId = data.storeroom_id || {{ storeroom.id }};
            const submittedIds = inventoryIds;
            const allIds = originalInventoryIds.split(',').filter(id => id);
            const remainingIds = allIds.filter(id => !submittedIds.includes(parseInt(id))).join(',');
            
            if (remainingIds) {
                window.location.href = '/inventory/stocking-gui?storeroom_id=' + storeroomId + '&inventory_ids=' + remainingIds;
            } else {
                // No more items, go back to selection
                window.location.href = '/inventory/initial-stocking?storeroom_id=' + storeroomId;
            }
        } else {
            alert('Error: ' + (data.error || 'An error occurred'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Movement';
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Movement';
    });
}
</script>
{% endblock %}

