{# Partial template for HTMX responses - returns storeroom builder sections #}

{# Storeroom Builder Selector - main target #}
<div id="storeroomBuilderSelector">
    <!-- Location Viewer Card -->
    {% set svg_content = storeroom.svg_content %}
    {% set selected_location_id = location_id %}
    {% set mode = 'htmx' %}
    {% set sidebar_heading = 'locations' %}
    {% set svg_area_id = 'location-svg-area' %}
    {% macro location_card_url(loc_id) -%}
        {{ url_for('inventory.storeroom_build', storeroom_id=storeroom.id, location_id=loc_id) }}
    {%- endmacro %}
    {% set card_url_builder = location_card_url %}
    {% set card_footer_content %}
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <form method="POST" action="{{ url_for('inventory.storeroom_upload_layout', storeroom_id=storeroom.id) }}" 
                  enctype="multipart/form-data" class="d-flex gap-2 align-items-center flex-grow-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <label class="mb-0 text-nowrap">Delete Current locations and bins and upload new:</label>
                <input type="file" name="svg_file" accept=".svg" class="form-control form-control-sm">
                <button type="submit" class="btn btn-sm btn-outline-primary">Upload</button>
            </form>
            <div class="d-flex gap-2">
                {% if storeroom.svg_content %}
                <a href="{{ url_for('inventory.storeroom_view_svg', storeroom_id=storeroom.id) }}" 
                   class="btn btn-sm btn-outline-secondary" target="_blank" title="View processed SVG layout">
                    <i class="bi bi-image"></i> Processed SVG
                </a>
                {% endif %}
                {% if storeroom.raw_svg %}
                <a href="{{ url_for('inventory.storeroom_view_raw_svg', storeroom_id=storeroom.id) }}" 
                   class="btn btn-sm btn-outline-secondary" target="_blank" title="View original uploaded SVG">
                    <i class="bi bi-file-image"></i> Raw SVG
                </a>
                {% endif %}
            </div>
        </div>
    {% endset %}
    {% set extra_sidebar_content %}
        <!-- Add Location Form -->
        <div class="mt-3">
            <h6 class="mb-2">Add Location</h6>
            <form method="POST" action="{{ url_for('inventory.storeroom_add_location', storeroom_id=storeroom.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="mb-2">
                    <input type="text" name="location_name" required placeholder="Location ID" 
                           class="form-control form-control-sm">
                </div>
                <div class="mb-2">
                    <input type="text" name="display_name" placeholder="Display Name" 
                           class="form-control form-control-sm">
                </div>
                <button type="submit" class="btn btn-primary btn-sm w-100">Add Location</button>
            </form>
        </div>
    {% endset %}
    {% include 'inventory/shared/_location_viewer.html' %}

    <!-- Bin Viewer Card -->
    {% if selected_location %}
        {% set bins_list = [] %}
        {% for bin in selected_location.bins|sort(attribute='bin_tag') %}
            {% set _ = bins_list.append({'id': bin.id, 'bin_tag': bin.bin_tag, 'display_name': bin.bin_tag}) %}
        {% endfor %}
        {% set selected_bin_id = bin_id %}
        {% set mode = 'htmx' %}
        {% set sidebar_heading = 'BINS' %}
        {% macro bin_card_url(b_id) -%}
            {{ url_for('inventory.storeroom_build', storeroom_id=storeroom.id, location_id=location_id, bin_id=b_id) }}
        {%- endmacro %}
        {% set card_url_builder = bin_card_url %}
        {% set card_footer_content %}
            <form method="POST" action="{{ url_for('inventory.location_upload_bin_layout', location_id=selected_location.id) }}" 
                  enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <label class="mb-0 text-nowrap">Delete current Bins and upload new layout:</label>
                <input type="file" name="svg_file" accept=".svg" class="form-control form-control-sm">
                <button type="submit" class="btn btn-sm btn-outline-primary">Upload</button>
            </form>
        {% endset %}
        {% set extra_sidebar_content %}
            <!-- Add Bin Form -->
            <div class="mt-3">
                <h6 class="mb-2">Add Bin</h6>
                <form method="POST" action="{{ url_for('inventory.location_add_bin', location_id=selected_location.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-2">
                        <input type="text" name="bin_tag" required placeholder="Bin Tag" 
                               class="form-control form-control-sm">
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100">Add Bin</button>
                </form>
            </div>
        {% endset %}
        {% include 'inventory/shared/_bin_viewer.html' %}
        {% endif %}
</div>

