{% extends "base.html" %}

{% block title %}{{ storeroom.room_name }} - Storeroom Designer{% endblock %}

{% block head %}
<style>
    /* SVG Display Area */
    .svg-display-area {
        height: 500px !important;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
        padding: 20px;
        text-align: center;
        box-sizing: border-box;
        width: 100%;
        position: relative;
    }
    
    .svg-display-area:empty::before {
        content: "No layout SVG uploaded yet";
        display: block;
        color: #6c757d;
        padding: 20px;
    }
    .bin-svg-container {
        height: 500px !important;
    }
    
    /* Responsive SVG with aspect ratio preservation */
    .svg-display-area svg {
        max-width: 100%;
        max-height: 100%!important;
        height: auto;
        display: block;
    }
    
    /* Ensure SVG container in column takes full width */
    .col-lg-8 {
        width: 100%;
    }
    
    /* Locations/Bins List */
    .locations-sidebar {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .location-card {
        transition: all 0.2s;
        border-left: 4px solid #dee2e6;
        cursor: pointer;
        margin-bottom: 0.5rem;
    }
    
    .location-card:hover {
        border-left-color: #0d6efd;
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .location-card.selected {
        border-left-color: #0d6efd;
        background-color: #e7f1ff;
    }
    
    .location-card.highlighted {
        background-color: #b3d9ff !important;
        border-left-color: #0d6efd !important;
    }
    
    /* More specific selector to override .location-element */
    .location-element.location-svg-selected,
    [data-location-id].location-svg-selected,
    .location-svg-selected {
        fill: #ca3535 !important;
    }
    
    /* Bin card highlighting */
    .location-card.highlighted-bin {
        background-color: #b3d9ff !important;
        border-left-color: #0d6efd !important;
    }
    
    /* More specific selector to override .bin-element */
    .bin-element.bin-svg-selected,
    [data-bin-id].bin-svg-selected,
    [data-bin-tag].bin-svg-selected,
    .bin-svg-selected {
        fill: #a03030 !important;
    }
    
    .sidebar-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .sidebar-list-item {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .sidebar-list-item:hover {
        background: #e9ecef;
    }
    
    .sidebar-list-item.selected {
        background: #fff3cd;
        font-weight: bold;
        border-left: 4px solid #ffc107;
    }
    
    /* SVG Element Styling */
    .location-element {
        fill: #4a90e2 !important;
        cursor: pointer;
        transition: fill 0.3s;
    }
    
    .location-element:hover {
        fill: #ffcc00 !important;
    }
    
    .location-element.selected {
        fill: #ff6b6b !important;
    }
    
    .bin-element {
        fill: #4a90e2 !important;
        cursor: pointer;
        transition: fill 0.3s;
    }
    
    .bin-element:hover {
        fill: #ffcc00 !important;
    }
    
    .bin-element.selected {
        fill: #ff6b6b !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-building"></i> {{ storeroom.room_name }}
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-geo-alt"></i> {{ storeroom.major_location.name if storeroom.major_location else 'N/A' }}
                    </p>
                </div>
                <div>
                    {% if storeroom.svg_content %}
                    <a href="{{ url_for('inventory.storeroom_view_svg', storeroom_id=storeroom.id) }}" 
                       class="btn btn-outline-primary me-2" target="_blank">
                        <i class="bi bi-image"></i> View Processed SVG
                    </a>
                    {% endif %}
                    {% if storeroom.raw_svg %}
                    <a href="{{ url_for('inventory.storeroom_view_raw_svg', storeroom_id=storeroom.id) }}" 
                       class="btn btn-outline-primary me-2" target="_blank">
                        <i class="bi bi-file-image"></i> View Raw SVG
                    </a>
                    {% endif %}
                    <a href="{{ url_for('inventory.storeroom_view', storeroom_id=storeroom.id) }}" 
                       class="btn btn-outline-info me-2">
                        <i class="bi bi-eye"></i> View Summary
                    </a>
                    <a href="{{ url_for('inventory.storeroom_edit', storeroom_id=storeroom.id) }}" 
                       class="btn btn-outline-secondary me-2">
                        <i class="bi bi-pencil"></i> Edit Storeroom
                    </a>
                    <a href="{{ url_for('inventory.storeroom_index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Viewer Card -->
    <div id="storeroomBuilderSelector" hx-boost="true" hx-push-url="true" hx-target="#storeroomBuilderSelector" hx-select="#storeroomBuilderSelector" hx-swap="outerHTML">
        {% set svg_content = storeroom.svg_content %}
        {% set selected_location_id = location_id %}
        {% set mode = 'htmx' %}
        {% set sidebar_heading = 'locations' %}
        {% set svg_area_id = 'location-svg-area' %}
        {% macro location_card_url(loc_id) -%}
            {{ url_for('inventory.storeroom_build', storeroom_id=storeroom.id, location_id=loc_id, bin_id=bin_id or '') }}
        {%- endmacro %}
        {% set card_url_builder = location_card_url %}
        {% set card_footer_content %}
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <form method="POST" action="{{ url_for('inventory.storeroom_upload_layout', storeroom_id=storeroom.id) }}" 
                      enctype="multipart/form-data" class="d-flex gap-2 align-items-center flex-grow-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <label class="mb-0 text-nowrap">Delete Current locations and bins and upload new:</label>
                    <input type="file" name="svg_file" accept=".svg" class="form-control form-control-sm">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Upload</button>
                </form>
                <div class="d-flex gap-2">
                    {% if storeroom.svg_content %}
                    <a href="{{ url_for('inventory.storeroom_view_svg', storeroom_id=storeroom.id) }}" 
                       class="btn btn-sm btn-outline-secondary" target="_blank" title="View processed SVG layout">
                        <i class="bi bi-image"></i> Processed SVG
                    </a>
                    {% endif %}
                    {% if storeroom.raw_svg %}
                    <a href="{{ url_for('inventory.storeroom_view_raw_svg', storeroom_id=storeroom.id) }}" 
                       class="btn btn-sm btn-outline-secondary" target="_blank" title="View original uploaded SVG">
                        <i class="bi bi-file-image"></i> Raw SVG
                    </a>
                    {% endif %}
                </div>
            </div>
        {% endset %}
        {% set extra_sidebar_content %}
            <!-- Add Location Form -->
            <div class="mt-3">
                <h6 class="mb-2">Add Location</h6>
                <form method="POST" action="{{ url_for('inventory.storeroom_add_location', storeroom_id=storeroom.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-2">
                        <input type="text" name="location_name" required placeholder="Location ID" 
                               class="form-control form-control-sm">
                    </div>
                    <div class="mb-2">
                        <input type="text" name="display_name" placeholder="Display Name" 
                               class="form-control form-control-sm">
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100">Add Location</button>
                </form>
            </div>
        {% endset %}
        {% include 'inventory/shared/_location_viewer.html' %}

        <!-- Bin Viewer Card -->
        {% if selected_location %}
        {% set bins_list = [] %}
        {% for bin in selected_location.bins|sort(attribute='bin_tag') %}
            {% set _ = bins_list.append({'id': bin.id, 'bin_tag': bin.bin_tag, 'display_name': bin.bin_tag}) %}
        {% endfor %}
        {% set selected_bin_id = bin_id %}
        {% set mode = 'htmx' %}
        {% set sidebar_heading = 'BINS' %}
        {% macro bin_card_url(b_id) -%}
            {{ url_for('inventory.storeroom_build', storeroom_id=storeroom.id, location_id=location_id, bin_id=b_id) }}
        {%- endmacro %}
        {% set card_url_builder = bin_card_url %}
        {% set extra_sidebar_content %}
            <!-- Add Bin Form -->
            <div class="mt-3">
                <h6 class="mb-2">Add Bin</h6>
                <form method="POST" action="{{ url_for('inventory.location_add_bin', location_id=selected_location.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-2">
                        <input type="text" name="bin_tag" required placeholder="Bin Tag" 
                               class="form-control form-control-sm">
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100">Add Bin</button>
                </form>
            </div>
        {% endset %}
        {% set card_footer_content %}
            <form method="POST" action="{{ url_for('inventory.location_upload_bin_layout', location_id=selected_location.id) }}" 
                  enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <label class="mb-0 text-nowrap">Delete current Bins and upload new layout:</label>
                <input type="file" name="svg_file" accept=".svg" class="form-control form-control-sm">
                <button type="submit" class="btn btn-sm btn-outline-primary">Upload</button>
            </form>
        {% endset %}
        {% include 'inventory/shared/_bin_viewer.html' %}
        {% endif %}
    </div>
</div>

<!-- Delete Forms (hidden) -->
<form id="deleteLocationForm" method="POST" style="display:none;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/></form>
<form id="deleteBinForm" method="POST" style="display:none;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/></form>

<script>
// Global variables for current page state
const currentStoreroomId = {{ storeroom.id }};
const currentLocationId = {% if location_id %}{{ location_id }}{% else %}null{% endif %};
const currentBinId = {% if bin_id %}{{ bin_id }}{% else %}null{% endif %};

// Function to handle location selection from SVG click
function locationSelected(locationId) {
    if (!currentStoreroomId) {
        console.error('Missing required parameters for location selection');
        return;
    }
    
    // Build URL
    const params = new URLSearchParams();
    params.set('location_id', locationId);
    if (currentBinId) {
        params.set('bin_id', currentBinId);
    }
    
    const url = '/inventory/storeroom/' + currentStoreroomId + '/build?' + params.toString();
    
    // Update browser history
    history.pushState({}, '', url);
    
    // Make HTMX request
    htmx.ajax('GET', url, {
        target: '#storeroomBuilderSelector',
        swap: 'outerHTML',
        select: '#storeroomBuilderSelector'
    });
}

// Function to handle bin selection from SVG click
function binSelected(binId) {
    if (!currentStoreroomId || !currentLocationId) {
        console.error('Missing required parameters for bin selection');
        return;
    }
    
    // Build URL
    const params = new URLSearchParams();
    params.set('location_id', currentLocationId);
    params.set('bin_id', binId);
    
    const url = '/inventory/storeroom/' + currentStoreroomId + '/build?' + params.toString();
    
    // Update browser history
    history.pushState({}, '', url);
    
    // Make HTMX request
    htmx.ajax('GET', url, {
        target: '#storeroomBuilderSelector',
        swap: 'outerHTML',
        select: '#storeroomBuilderSelector'
    });
}

// Function to highlight selected location SVG elements
function highlightSelectedLocationSVG(locationId) {
    if (!locationId) return;
    
    // Find all SVG elements with data-location-id matching the selected location
    const svgElements = document.querySelectorAll(`[data-location-id="${locationId}"]`);
    
    svgElements.forEach(function(svgElement) {
        // Add class for CSS styling
        svgElement.classList.add('location-svg-selected');
        
        // Set fill and stroke colors directly
        svgElement.style.fill = '#ca3535';
        svgElement.style.stroke = '#ca3535';
        
        // Also highlight child elements (path, rect, circle, etc.)
        const childElements = svgElement.querySelectorAll('path, rect, circle, ellipse, polygon, polyline');
        childElements.forEach(function(child) {
            child.style.fill = '#ca3535';
            child.style.stroke = '#ca3535';
        });
    });
}

// Function to highlight selected bin SVG elements
function highlightSelectedBinSVG(binId) {
    if (!binId) return;
    
    // Find all SVG elements with data-bin-id matching the selected bin
    const binSvgElements = document.querySelectorAll(`[data-bin-id="${binId}"]`);
    
    binSvgElements.forEach(function(svgElement) {
        // Add class for CSS styling
        svgElement.classList.add('bin-svg-selected');
        
        // Set fill and stroke colors directly (using blue to distinguish from location highlighting)
        svgElement.style.fill = '#0d6efd';
        svgElement.style.stroke = '#0d6efd';
        
        // Also highlight child elements (path, rect, circle, etc.)
        const childElements = svgElement.querySelectorAll('path, rect, circle, ellipse, polygon, polyline');
        childElements.forEach(function(child) {
            child.style.fill = '#0d6efd';
            child.style.stroke = '#0d6efd';
        });
    });
}

// Function to apply all SVG highlighting based on current state
function applyAllSVGHighlighting() {
    {% if location_id %}
    highlightSelectedLocationSVG({{ location_id }});
    {% endif %}
    
    {% if bin_id %}
    highlightSelectedBinSVG({{ bin_id }});
    {% endif %}
}

// Highlight on initial page load
document.addEventListener('DOMContentLoaded', function() {
    applyAllSVGHighlighting();
});

// Re-highlight after HTMX settles (for AJAX navigation)
document.body.addEventListener('htmx:afterSettle', function(event) {
    // Only run for the storeroom builder selector updates
    if (event.detail.target.id === 'storeroomBuilderSelector' || 
        event.detail.target.closest('#storeroomBuilderSelector')) {
        console.log('HTMX settle complete, re-applying SVG highlighting');
        
        // Update global state variables from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const newLocationId = urlParams.get('location_id');
        const newBinId = urlParams.get('bin_id');
        
        // Update global variables
        if (newLocationId) window.currentLocationId = parseInt(newLocationId);
        if (newBinId) window.currentBinId = parseInt(newBinId);
        
        // Re-apply highlighting
        highlightSelectedLocationSVG(newLocationId);
        highlightSelectedBinSVG(newBinId);
    }
});
</script>

{% endblock %}

