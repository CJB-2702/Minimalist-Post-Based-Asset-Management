{% extends "base.html" %}

{% block title %}{{ storeroom.room_name }} - Storeroom Designer{% endblock %}

{% block head %}
<style>
    /* SVG Display Area */
    .svg-display-area {
        height: 500px !important;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
        padding: 20px;
        text-align: center;
        box-sizing: border-box;
        width: 100%;
        position: relative;
    }
    
    .svg-display-area:empty::before {
        content: "No layout SVG uploaded yet";
        display: block;
        color: #6c757d;
        padding: 20px;
    }
    .bin-svg-container {
        height: 500px !important;
    }
    
    /* Responsive SVG with aspect ratio preservation */
    .svg-display-area svg {
        max-width: 100%;
        max-height: 100%!important;
        height: auto;
        display: block;
    }
    
    /* Ensure SVG container in column takes full width */
    .col-lg-8 {
        width: 100%;
    }
    
    /* Locations/Bins List */
    .locations-sidebar {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .location-card {
        transition: all 0.2s;
        border-left: 4px solid #dee2e6;
        cursor: pointer;
        margin-bottom: 0.5rem;
    }
    
    .location-card:hover {
        border-left-color: #0d6efd;
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .location-card.selected {
        border-left-color: #0d6efd;
        background-color: #e7f1ff;
    }
    
    .location-card.highlighted {
        background-color: #b3d9ff !important;
        border-left-color: #0d6efd !important;
    }
    
    /* More specific selector to override .location-element */
    .location-element.location-svg-selected,
    [data-location-id].location-svg-selected,
    .location-svg-selected {
        fill: #ca3535 !important;
    }
    
    /* Bin card highlighting */
    .location-card.highlighted-bin {
        background-color: #b3d9ff !important;
        border-left-color: #0d6efd !important;
    }
    
    /* More specific selector to override .bin-element */
    .bin-element.bin-svg-selected,
    [data-bin-id].bin-svg-selected,
    [data-bin-tag].bin-svg-selected,
    .bin-svg-selected {
        fill: #a03030 !important;
    }
    
    .sidebar-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .sidebar-list-item {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .sidebar-list-item:hover {
        background: #e9ecef;
    }
    
    .sidebar-list-item.selected {
        background: #fff3cd;
        font-weight: bold;
        border-left: 4px solid #ffc107;
    }
    
    /* SVG Element Styling */
    .location-element {
        fill: #4a90e2 !important;
        cursor: pointer;
        transition: fill 0.3s;
    }
    
    .location-element:hover {
        fill: #ffcc00 !important;
    }
    
    .location-element.selected {
        fill: #ff6b6b !important;
    }
    
    .bin-element {
        fill: #4a90e2 !important;
        cursor: pointer;
        transition: fill 0.3s;
    }
    
    .bin-element:hover {
        fill: #ffcc00 !important;
    }
    
    .bin-element.selected {
        fill: #ff6b6b !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-building"></i> {{ storeroom.room_name }}
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-geo-alt"></i> {{ storeroom.major_location.name if storeroom.major_location else 'N/A' }}
                    </p>
                </div>
                <div>
                    {% if storeroom.svg_content %}
                    <a href="{{ url_for('inventory.storeroom_view_svg', storeroom_id=storeroom.id) }}" 
                       class="btn btn-outline-primary me-2" target="_blank">
                        <i class="bi bi-image"></i> View Processed SVG
                    </a>
                    {% endif %}
                    {% if storeroom.raw_svg %}
                    <a href="{{ url_for('inventory.storeroom_view_raw_svg', storeroom_id=storeroom.id) }}" 
                       class="btn btn-outline-primary me-2" target="_blank">
                        <i class="bi bi-file-image"></i> View Raw SVG
                    </a>
                    {% endif %}
                    <a href="{{ url_for('inventory.storeroom_view', storeroom_id=storeroom.id) }}" 
                       class="btn btn-outline-info me-2">
                        <i class="bi bi-eye"></i> View Summary
                    </a>
                    <a href="{{ url_for('inventory.storeroom_edit', storeroom_id=storeroom.id) }}" 
                       class="btn btn-outline-secondary me-2">
                        <i class="bi bi-pencil"></i> Edit Storeroom
                    </a>
                    <a href="{{ url_for('inventory.storeroom_index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Viewer Card -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h3 class="mb-0"><em>location Viewer</em></h3>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Main Content Area (Left 2/3) -->
                <div class="col-lg-8">

                    <div class="svg-display-area" id="location-svg-area">
                        {% if storeroom.svg_content %}
                            <div>
                                {{ storeroom.svg_content|safe }}
                            </div>
                        {% else %}
                            <div class="text-muted text-center">
                                <p><em>No layout SVG uploaded yet</em></p>
                                <p class="small">Upload a layout SVG using the form below</p>
                                <p class="small">There <b>must</b> be a layer with name "locations" and you Must name each of the items in the location layer manually in inkscape</p>
                            </div>
                        {% endif %}
                    </div>

                </div>
                
                <!-- Sidebar (Right 1/3) -->
                <div class="col-lg-4">
                    <h4 class="mb-3"><em>locations</em></h4>
                    <div class="locations-sidebar">
                        {% if locations %}
                            <div class="row g-2">
                                {% for location in locations %}
                                <div class="col-6">
                                    <div class="card location-card {% if selected_location and selected_location.id == location.id %}selected{% endif %}"
                                         data-location-id="{{ location.id }}"
                                         data-location-name="{{ location.display_name }}"
                                         onclick="locationSelected({{ location.id }})">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">
                                                        {{ location.display_name}}
                                                    </h6>
                                                    {% if location.location != location.display_name %}
                                                    <p class="text-muted small mb-1">ID: {{ location.location }}</p>
                                                    {% endif %}
                                                    <div class="small text-muted">
                                                        <i class="bi bi-grid-3x3-gap"></i> {{ location.bin_count }} bin{{ 's' if location.bin_count != 1 else '' }}
                                                    </div>
                                                </div>
                                                <span class="badge bg-info">ID: {{ location.id }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-3"><em>No locations found</em></p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Add Location Form -->
                    <div class="mt-3">
                        <h6 class="mb-2">Add Location</h6>
                        <form method="POST" action="{{ url_for('inventory.storeroom_add_location', storeroom_id=storeroom.id) }}">
                            <div class="mb-2">
                                <input type="text" name="location_name" required placeholder="Location ID" 
                                       class="form-control form-control-sm">
                            </div>
                            <div class="mb-2">
                                <input type="text" name="display_name" placeholder="Display Name" 
                                       class="form-control form-control-sm">
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm w-100">Add Location</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <form method="POST" action="{{ url_for('inventory.storeroom_upload_layout', storeroom_id=storeroom.id) }}" 
                      enctype="multipart/form-data" class="d-flex gap-2 align-items-center flex-grow-1">
                    <label class="mb-0 text-nowrap">Delete Current locations and bins and upload new:</label>
                    <input type="file" name="svg_file" accept=".svg" class="form-control form-control-sm">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Upload</button>
                </form>
                <div class="d-flex gap-2">
                    {% if storeroom.svg_content %}
                    <a href="{{ url_for('inventory.storeroom_view_svg', storeroom_id=storeroom.id) }}" 
                       class="btn btn-sm btn-outline-secondary" target="_blank" title="View processed SVG layout">
                        <i class="bi bi-image"></i> Processed SVG
                    </a>
                    {% endif %}
                    {% if storeroom.raw_svg %}
                    <a href="{{ url_for('inventory.storeroom_view_raw_svg', storeroom_id=storeroom.id) }}" 
                       class="btn btn-sm btn-outline-secondary" target="_blank" title="View original uploaded SVG">
                        <i class="bi bi-file-image"></i> Raw SVG
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bin Viewer Card -->
    {% if selected_location %}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h3 class="mb-0"><em>Bin Viewer {{selected_location.display_name}}</em></h3>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Main Content Area (Left 2/3) -->
                <div class="col-lg-8">
                    <div class="svg-display-area" id="bin-svg-area">
                        {% if selected_location and selected_location.bin_layout_svg %}
                            <div>
                                {{ selected_location.bin_layout_svg|safe }}
                            </div>
                        {% else %}
                            <div class="text-muted text-center">
                                <p><em>No bin layout SVG uploaded yet</em></p>
                                <p class="small">Upload a bin layout SVG using the form below</p>
                                <p class="small">There <b>must</b> be a layer with name "bins" and you Must name each of the items in the bin layer manually in inkscape</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Sidebar (Right 1/3) -->
                <div class="col-lg-4">
                    <h4 class="mb-3"><em>BINS</em></h4>
                    <div class="locations-sidebar">
                        {% if selected_location.bins %}
                            <div class="row g-2">
                                {% for bin in selected_location.bins|sort(attribute='bin_tag') %}
                                <div class="col-6">
                                    <div class="card location-card"
                                         data-bin-tag="{{ bin.bin_tag }}"
                                         data-bin-id="{{ bin.id }}">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">
                                                        {{ bin.bin_tag }}
                                                    </h6>
                                                </div>
                                                <span class="badge bg-info">ID: {{ bin.id }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-3"><em>No bins found</em></p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Add Bin Form -->
                    <div class="mt-3">
                        <h6 class="mb-2">Add Bin</h6>
                        <form method="POST" action="{{ url_for('inventory.location_add_bin', location_id=selected_location.id) }}">
                            <div class="mb-2">
                                <input type="text" name="bin_tag" required placeholder="Bin Tag" 
                                       class="form-control form-control-sm">
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm w-100">Add Bin</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <form method="POST" action="{{ url_for('inventory.location_upload_bin_layout', location_id=selected_location.id) }}" 
                  enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                <label class="mb-0 text-nowrap">Delete current Bins and upload new layout:</label>
                <input type="file" name="svg_file" accept=".svg" class="form-control form-control-sm">
                <button type="submit" class="btn btn-sm btn-outline-primary">Upload</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Forms (hidden) -->
<form id="deleteLocationForm" method="POST" style="display:none;"></form>
<form id="deleteBinForm" method="POST" style="display:none;"></form>

<script>
// Redirect to build page with location_id query parameter
function locationSelected(locationId) {
    window.location.href = '/inventory/storeroom/{{ storeroom.id }}/build?location_id=' + locationId;
}

function binSelected(binId) {
    // Get current location_id from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const locationId = urlParams.get('location_id');
    
    // Build URL with both location_id and bin_id
    let url = '/inventory/storeroom/{{ storeroom.id }}/build?';
    if (locationId) {
        url += 'location_id=' + locationId + '&';
    }
    url += 'bin_id=' + binId;
    
    window.location.href = url;
}

// Highlight selected location on page load
document.addEventListener('DOMContentLoaded', function() {
    // Get location_id from URL query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const locationId = urlParams.get('location_id');
    console.log(locationId);
    
    if (locationId) {
        // Find and highlight the location card
        const locationCard = document.querySelector(`.location-card[data-location-id="${locationId}"]`);
        if (locationCard) {
            locationCard.classList.add('highlighted');
            // Also set inline style as fallback
            locationCard.style.backgroundColor = '#b3d9ff';
            locationCard.style.borderLeftColor = '#0d6efd';
        }
        
        // Find and highlight SVG elements with matching data-location-id
        const svgArea = document.getElementById('location-svg-area');
        if (svgArea) {
            const svgElements = svgArea.querySelectorAll(`[data-location-id="${locationId}"]`);
            svgElements.forEach(function(element) {
                element.classList.add('location-svg-selected');
                // Set fill directly with !important via style attribute
                element.style.setProperty('fill', '#ca3535', 'important');
            });
        }
    }
    
    // Get bin_id or bin_tag from URL query parameters
    const binId = urlParams.get('bin_id');
    const binTag = urlParams.get('bin_tag');
    const binIdentifier = binId || binTag;
    console.log('bin_id:', binId, 'bin_tag:', binTag);
    
    if (binIdentifier) {
        // Find and highlight the bin card (try both bin_id and bin_tag)
        const binCard = document.querySelector(`.location-card[data-bin-id="${binIdentifier}"], .location-card[data-bin-tag="${binIdentifier}"]`);
        if (binCard) {
            binCard.classList.add('highlighted-bin');
            // Also set inline style as fallback
            binCard.style.backgroundColor = '#b3d9ff';
            binCard.style.borderLeftColor = '#0d6efd';
        }
        
        // Find and highlight SVG elements with matching data-bin-id or data-bin-tag
        const binSvgArea = document.getElementById('bin-svg-area');
        if (binSvgArea) {
            // Try both data-bin-id and data-bin-tag attributes
            const binSvgElements = binSvgArea.querySelectorAll(`[data-bin-id="${binIdentifier}"], [data-bin-tag="${binIdentifier}"]`);
            binSvgElements.forEach(function(element) {
                element.classList.add('bin-svg-selected');
                // Set fill directly with !important via style attribute
                element.style.setProperty('fill', '#ca3535', 'important');
            });
        }
    }
});
</script>

{% endblock %}

