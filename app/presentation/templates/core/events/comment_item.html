{% set comment_data_item = comment_data %}
{% set edit_history = comment_data_item.get('edit_history', []) if comment_data_item else [] %}
{% set metadata = comment_data_item.get('metadata', None) if comment_data_item else None %}

<div class="comment-box" 
     id="comment-{{ comment.id }}"
     data-comment-id="{{ comment.id }}">
    <!-- Comment Header -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center gap-2">
            <small class="text-muted">
                {% if comment.created_at %}
                    {{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                    Unknown time
                {% endif %}
            </small>
            <strong>{{ comment.created_by.username if comment.created_by else 'Unknown' }}</strong>
            {% if comment.is_human_made %}
                <span class="badge bg-primary" title="Human-made comment">
                    <i class="bi bi-person"></i> Human
                </span>
            {% else %}
                <span class="badge bg-info" title="Machine-generated comment">
                    <i class="bi bi-robot"></i> Auto
                </span>
            {% endif %}
        </div>
        <!-- Comment Actions (inline with header) -->
        <div class="d-flex gap-1">
            <button 
                class="btn btn-sm btn-outline-secondary reply-btn" 
                data-comment-id="{{ comment.id }}"
                data-comment-preview="{{ comment.get_content_preview(50)|e }}"
                title="Reply to this comment">
                <i class="bi bi-reply"></i>
            </button>
            
            <button 
                class="btn btn-sm btn-outline-info" 
                data-bs-toggle="modal"
                data-bs-target="#commentMetadataModal-{{ comment.id }}"
                title="View comment metadata">
                <i class="bi bi-eye"></i>
            </button>
            {% if comment_data.show_edit %}
            <button 
                class="btn btn-sm btn-outline-primary" 
                data-bs-toggle="modal"
                data-bs-target="#editCommentModal-{{ comment.id }}"
                title="Edit this comment">
                <i class="bi bi-pencil"></i>
            </button>
            <button 
                class="btn btn-sm btn-outline-danger" 
                data-bs-toggle="modal"
                data-bs-target="#deleteCommentModal-{{ comment.id }}"
                title="Delete this comment">
                <i class="bi bi-trash"></i>
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Reply Indicator -->
    {% if comment.replied_to_comment_id and comment.replied_to_comment %}
    <div class="reply-indicator mb-2">
        <i class="bi bi-reply"></i> 
        Replying to 
        <a href="#comment-{{ comment.replied_to_comment_id }}" 
           class="reply-link scroll-to-comment"
           data-comment-id="{{ comment.replied_to_comment_id }}">
            {{ comment.replied_to_comment.get_content_preview(30) }}
        </a>
        <span class="text-muted"> by {{ comment.replied_to_comment.created_by.username if comment.replied_to_comment.created_by else 'Unknown' }}</span>
    </div>
    {% endif %}
    
    <!-- Comment Content -->
    <p class="mb-2 comment-content">{{ comment.content }}</p>

    {% if comment.comment_attachments %}
    <div class="comment-attachments mt-2">
        <small class="text-muted d-block mb-2"><strong>Attachments:</strong></small>
        <div class="row">
            {% for ca in comment.comment_attachments %}
            {% set att = ca.attachment %}
            <div class="col-6 col-md-4 mb-2">
                <div class="card attachment-mini-card">
                    {% if att.is_image() %}
                        <a href="{{ url_for('attachments.view', attachment_id=att.id) }}"
                           target="_blank"
                           class="d-flex justify-content-center">
                            <img src="{{ url_for('attachments.view', attachment_id=att.id) }}"
                                 class="img-thumbnail"
                                 alt="{{ att.filename }}"
                                 style="width: 100px; height: 100px; object-fit: cover;">
                        </a>
                    {% elif att.is_viewable_as_text() %}
                        <div class="card-img-top bg-light" style="height: 100px; overflow: hidden;">
                            <div class="p-2">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <i class="bi {{ att.get_file_icon() }} text-muted"></i>
                                    <small class="text-muted">{{ att.get_file_size_display() }}</small>
                                </div>
                                <div class="text-preview"
                                     hx-get="{{ url_for('attachments.preview', attachment_id=att.id) }}"
                                     hx-trigger="load"
                                     hx-swap="innerHTML"
                                     style="font-size: 0.7rem; line-height: 1.2; max-height: 70px; overflow: hidden;">
                                    <div class="text-center text-muted">
                                        <i class="bi bi-hourglass-split"></i> Loading preview...
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                             style="height: 100px;">
                            <i class="bi {{ att.get_file_icon() }} fs-3 text-muted"></i>
                        </div>
                    {% endif %}
                    <div class="card-body p-2">
                        <h6 class="card-title text-truncate small mb-1">{{ att.filename }}</h6>
                        <p class="card-text small text-muted mb-1">
                            {{ att.get_file_size_display() }}
                        </p>
                        <div class="btn-group btn-group-sm w-100" role="group">
                            <a href="{{ url_for('attachments.download', attachment_id=att.id) }}"
                               class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-download"></i>
                            </a>
                            {% if att.is_image() or att.is_viewable_as_text() %}
                            <a href="{{ url_for('attachments.view', attachment_id=att.id) }}"
                               class="btn btn-outline-secondary btn-sm" target="_blank">
                                <i class="bi bi-eye"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Pre-rendered Modals for this comment (only if user owns the comment) -->
{% if comment.created_by_id == current_user.id %}
    <!-- Edit Comment Modal -->
    <div class="modal fade" id="editCommentModal-{{ comment.id }}" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST" 
                      action="{{ url_for('comments.edit', comment_id=comment.id) }}"
                      hx-post="{{ url_for('comments.edit', comment_id=comment.id) }}{% if filter_human_only|default(false) %}?human_only=true{% endif %}"
                      hx-target="#comment-{{ comment.id }}"
                      hx-swap="outerHTML"
                      enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Comment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="edit_content_{{ comment.id }}" class="form-label">Comment</label>
                            <textarea class="form-control" id="edit_content_{{ comment.id }}" name="content" rows="4" required>{{ comment.content }}</textarea>
                        </div>
                        
                        <!-- Edit History Section -->
                        {% if edit_history|length > 1 %}
                        <div class="mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start" type="button" 
                                            data-bs-toggle="collapse"
                                            data-bs-target="#editHistoryCollapse-{{ comment.id }}"
                                            aria-expanded="false">
                                        <i class="bi bi-clock-history"></i> 
                                        <span>Edit History ({{ edit_history|length }} versions)</span>
                                        <i class="bi bi-chevron-down float-end"></i>
                                    </button>
                                </div>
                                <div class="collapse" id="editHistoryCollapse-{{ comment.id }}">
                                    <div class="card-body">
                                        <div class="edit-history-timeline">
                                            {% for version in edit_history %}
                                            <div class="edit-history-item {% if version.is_current %}current-version{% endif %}">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <div class="d-flex align-items-center">
                                                        <small class="text-muted me-2">
                                                            {% if version.created_at %}
                                                                {{ version.created_at }}
                                                            {% else %}
                                                                No date
                                                            {% endif %}
                                                        </small>
                                                        <span>
                                                            <strong>{% if loop.index0 == 0 %}Original{% else %}Edit {{ loop.index0 }}{% endif %}</strong>
                                                            {% if version.is_current %}
                                                                <span class="badge bg-primary ms-2">Current</span>
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <small class="text-muted">by {{ version.created_by_username or 'Unknown' }}</small>
                                                </div>
                                                <div class="edit-history-content">{{ version.content }}</div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Comment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Comment Modal -->
    <div class="modal fade" id="deleteCommentModal-{{ comment.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this comment? This action cannot be undone.</p>
                    <div class="alert alert-warning">
                        <small>{{ comment.get_content_preview(100) }}</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="POST"
                          action="{{ url_for('comments.delete', comment_id=comment.id) }}"
                          hx-post="{{ url_for('comments.delete', comment_id=comment.id) }}{% if filter_human_only|default(false) %}?human_only=true{% endif %}"
                          hx-target="#comment-{{ comment.id }}"
                          hx-swap="outerHTML"
                          style="display: inline;">
                        <button type="submit" class="btn btn-danger">Delete Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


{% endif %}
<!-- Comment Metadata Modal -->
{% if metadata %}
<div class="modal fade" id="commentMetadataModal-{{ comment.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Comment Metadata
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Comment ID: {{ comment.id }}</h6>
                    <button class="btn btn-sm btn-outline-secondary copy-json-btn" 
                            data-json='{{ metadata }}'
                            title="Copy JSON to clipboard">
                        <i class="bi bi-clipboard"></i> Copy JSON
                    </button>
                </div>
                <pre class="bg-light p-3 rounded border" style="max-height: 500px; overflow-y: auto; font-size: 0.85rem;"><code>{{ metadata }}</code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

