{% extends "base.html" %}

{% block title %}{{ issuable_tool.tool.tool_name if issuable_tool.tool else 'Unknown' }} - Issuable Tool Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('core_supply_issuable_tools.list') }}">Issuable Tools</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{{ issuable_tool.tool.tool_name if issuable_tool.tool else 'Unknown' }}</li>
                    </ol>
                </nav>
                <h1>{{ issuable_tool.tool.tool_name if issuable_tool.tool else 'Unknown' }}</h1>
                {% if issuable_tool.serial_number %}
                <p class="text-muted">Serial: {{ issuable_tool.serial_number }}</p>
                {% endif %}
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('core_supply_issuable_tools.edit', issuable_tool_id=issuable_tool.id) }}" class="btn btn-secondary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <a href="{{ url_for('core_supply_issuable_tools.list') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Issuable Tools
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Issuable Tool Details -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Issuable Tool Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Tool Definition</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Tool Name:</strong></td>
                                <td>
                                    {% if issuable_tool.tool %}
                                    <a href="{{ url_for('core_supply_tools.detail', tool_id=issuable_tool.tool.id) }}">{{ issuable_tool.tool.tool_name }}</a>
                                    {% else %}
                                    Unknown
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Type:</strong></td>
                                <td>
                                    {% if issuable_tool.tool and issuable_tool.tool.tool_type %}
                                        <span class="badge bg-secondary">{{ issuable_tool.tool.tool_type }}</span>
                                    {% else %}
                                        <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Manufacturer:</strong></td>
                                <td>{{ issuable_tool.tool.manufacturer if issuable_tool.tool and issuable_tool.tool.manufacturer else 'Not specified' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Model Number:</strong></td>
                                <td>{{ issuable_tool.tool.model_number if issuable_tool.tool and issuable_tool.tool.model_number else 'Not specified' }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Issuable Tool Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Serial Number:</strong></td>
                                <td>{{ issuable_tool.serial_number or 'Not specified' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td>
                                    {% if issuable_tool.status == 'Available' %}
                                    <span class="badge bg-success">Available</span>
                                    {% elif issuable_tool.status == 'In Use' %}
                                    <span class="badge bg-warning">In Use</span>
                                    {% elif issuable_tool.status == 'Out for Repair' %}
                                    <span class="badge bg-danger">Out for Repair</span>
                                    {% elif issuable_tool.status == 'Retired' %}
                                    <span class="badge bg-secondary">Retired</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ issuable_tool.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Location:</strong></td>
                                <td>{{ issuable_tool.location or 'Not specified' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Assigned To:</strong></td>
                                <td>
                                    {% if issuable_tool.assigned_to %}
                                    <span class="badge bg-info">{{ issuable_tool.assigned_to.username }}</span>
                                    {% else %}
                                    <span class="text-muted">Unassigned</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Calibration Information -->
                <div class="mt-3">
                    <h6>Calibration Information</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Last Calibration:</strong></td>
                            <td>{{ issuable_tool.last_calibration_date.strftime('%Y-%m-%d') if issuable_tool.last_calibration_date else 'Not set' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Next Calibration:</strong></td>
                            <td>
                                {% if issuable_tool.next_calibration_date %}
                                {{ issuable_tool.next_calibration_date.strftime('%Y-%m-%d') }}
                                {% if issuable_tool.needs_calibration %}
                                <span class="badge bg-warning ms-2">Due</span>
                                {% elif issuable_tool.calibration_overdue %}
                                <span class="badge bg-danger ms-2">Overdue</span>
                                {% endif %}
                                {% else %}
                                Not set
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if issuable_tool.status == 'Available' and not issuable_tool.assigned_to %}
                    <form method="POST" action="{{ url_for('core_supply_issuable_tools.assign', issuable_tool_id=issuable_tool.id) }}" class="mb-2">
                        <select name="user_id" class="form-select form-select-sm mb-2" required>
                            <option value="">Select user...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="bi bi-person-plus"></i> Assign to User
                        </button>
                    </form>
                    {% elif issuable_tool.assigned_to %}
                    <form method="POST" action="{{ url_for('core_supply_issuable_tools.unassign', issuable_tool_id=issuable_tool.id) }}" class="mb-2">
                        <button type="submit" class="btn btn-warning btn-sm w-100">
                            <i class="bi bi-person-dash"></i> Unassign from {{ issuable_tool.assigned_to.username }}
                        </button>
                    </form>
                    {% endif %}
                    
                    {% if issuable_tool.status != 'Out for Repair' %}
                    <form method="POST" action="{{ url_for('core_supply_issuable_tools.mark_for_repair', issuable_tool_id=issuable_tool.id) }}" class="mb-2">
                        <button type="submit" class="btn btn-danger btn-sm w-100" onclick="return confirm('Mark this tool as out for repair?')">
                            <i class="bi bi-tools"></i> Mark for Repair
                        </button>
                    </form>
                    {% endif %}
                    
                    {% if issuable_tool.status != 'Retired' %}
                    <form method="POST" action="{{ url_for('core_supply_issuable_tools.retire', issuable_tool_id=issuable_tool.id) }}" class="mb-2">
                        <button type="submit" class="btn btn-secondary btn-sm w-100" onclick="return confirm('Retire this tool?')">
                            <i class="bi bi-x-circle"></i> Retire Tool
                        </button>
                    </form>
                    {% endif %}
                    
                    <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#calibrationModal">
                        <i class="bi bi-calendar-check"></i> Update Calibration
                    </button>
                    
                    <a href="{{ url_for('core_supply_issuable_tools.edit', issuable_tool_id=issuable_tool.id) }}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-pencil"></i> Edit Issuable Tool
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calibration Modal -->
<div class="modal fade" id="calibrationModal" tabindex="-1" aria-labelledby="calibrationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calibrationModalLabel">Update Calibration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('core_supply_issuable_tools.update_calibration', issuable_tool_id=issuable_tool.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="calibration_date" class="form-label">Last Calibration Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="calibration_date" name="calibration_date" 
                               value="{{ issuable_tool.last_calibration_date.strftime('%Y-%m-%d') if issuable_tool.last_calibration_date else '' }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="next_calibration_date" class="form-label">Next Calibration Date</label>
                        <input type="date" class="form-control" id="next_calibration_date" name="next_calibration_date" 
                               value="{{ issuable_tool.next_calibration_date.strftime('%Y-%m-%d') if issuable_tool.next_calibration_date else '' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Calibration</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

