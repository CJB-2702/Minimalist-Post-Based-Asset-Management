{% extends "base.html" %}

{% block title %}Plan Maintenance - {{ plan.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Plan Maintenance: {{ plan.name }}</h1>
            <div>
                <a href="{{ url_for('maintenance_plan.view_plan', plan_id=plan.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Plan
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Plan Summary -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Plan Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Plan ID:</dt>
                            <dd class="col-sm-8"><code>{{ plan.id }}</code></dd>
                            
                            <dt class="col-sm-4">Frequency Type:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-info">{{ plan.frequency_type }}</span>
                            </dd>
                            
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                {% if plan.status == 'Active' %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-warning">{{ plan.status }}</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Template:</dt>
                            <dd class="col-sm-8">
                                {% if plan.template_action_set %}
                                    {{ plan.template_action_set.task_name }}
                                {% else %}
                                    <span class="text-muted">No template assigned</span>
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Assets Needing Maintenance:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-primary">{{ results|length }}</span>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plan Information -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Plan Information</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">ID:</dt>
                    <dd class="col-sm-8"><code>{{ plan.id }}</code></dd>
                    
                    <dt class="col-sm-4">Name:</dt>
                    <dd class="col-sm-8"><strong>{{ plan.name }}</strong></dd>
                    
                    <dt class="col-sm-4">Description:</dt>
                    <dd class="col-sm-8">{{ plan.description or 'No description' }}</dd>
                    
                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                        {% if plan.status == 'Active' %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-warning">{{ plan.status }}</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Asset Type ID:</dt>
                    <dd class="col-sm-8">
                        <code>{{ plan.asset_type_id }}</code>
                        {% if plan.asset_type %}
                            <span class="text-muted">({{ plan.asset_type.name }})</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Model ID:</dt>
                    <dd class="col-sm-8">
                        {% if plan.model_id %}
                            <code>{{ plan.model_id }}</code>
                            {% if plan.model %}
                                <span class="text-muted">({{ plan.model.make }} {{ plan.model.model }}{% if plan.model.year %} {{ plan.model.year }}{% endif %})</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">All Models</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Template Action Set ID:</dt>
                    <dd class="col-sm-8">
                        <code>{{ plan.template_action_set_id }}</code>
                        {% if plan.template_action_set %}
                            <span class="text-muted">({{ plan.template_action_set.task_name }})</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Created:</dt>
                    <dd class="col-sm-8">
                        <small class="text-muted">
                            {{ plan.created_at.strftime('%Y-%m-%d %H:%M:%S') if plan.created_at else 'N/A' }}
                            {% if plan.created_by %}
                                by {{ plan.created_by.username }}
                            {% elif plan.created_by_id %}
                                (User ID: {{ plan.created_by_id }})
                            {% endif %}
                        </small>
                    </dd>
                    
                    <dt class="col-sm-4">Created By ID:</dt>
                    <dd class="col-sm-8">
                        <code>{{ plan.created_by_id or 'N/A' }}</code>
                    </dd>
                </dl>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Frequency Configuration</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Frequency Type:</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-info">{{ plan.frequency_type }}</span>
                    </dd>
                    
                    <dt class="col-sm-4">Delta Days:</dt>
                    <dd class="col-sm-8">
                        {% if plan.delta_days is not none %}
                            {{ plan.delta_days }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Delta Meter 1:</dt>
                    <dd class="col-sm-8">
                        {% if plan.delta_m1 is not none %}
                            {{ plan.delta_m1 }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Delta Meter 2:</dt>
                    <dd class="col-sm-8">
                        {% if plan.delta_m2 is not none %}
                            {{ plan.delta_m2 }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Delta Meter 3:</dt>
                    <dd class="col-sm-8">
                        {% if plan.delta_m3 is not none %}
                            {{ plan.delta_m3 }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Delta Meter 4:</dt>
                    <dd class="col-sm-8">
                        {% if plan.delta_m4 is not none %}
                            {{ plan.delta_m4 }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Last Updated:</dt>
                    <dd class="col-sm-8">
                        <small class="text-muted">
                            {{ plan.updated_at.strftime('%Y-%m-%d %H:%M:%S') if plan.updated_at else 'N/A' }}
                            {% if plan.updated_by %}
                                by {{ plan.updated_by.username }}
                            {% elif plan.updated_by_id %}
                                (User ID: {{ plan.updated_by_id }})
                            {% endif %}
                        </small>
                    </dd>
                    
                    <dt class="col-sm-4">Updated By ID:</dt>
                    <dd class="col-sm-8">
                        <code>{{ plan.updated_by_id or 'N/A' }}</code>
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Assets Needing Maintenance -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Assets Needing Maintenance</h5>
            </div>
            <div class="card-body">
                {% if results %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Asset ID</th>
                                <th>Asset Name</th>
                                <th>Serial Number</th>
                                <th>Reason</th>
                                <th>Due Date</th>
                                <th>Days Since Last</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td><code>{{ result.asset_id }}</code></td>
                                <td>
                                    <strong>{{ result.asset.name }}</strong>
                                </td>
                                <td>{{ result.asset.serial_number }}</td>
                                <td>
                                    <small>{{ result.reason }}</small>
                                    {% if result.errors %}
                                        <div class="text-danger">
                                            <small>
                                                <i class="bi bi-exclamation-triangle"></i>
                                                Errors: {{ result.errors|join(', ') }}
                                            </small>
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.due_date %}
                                        {{ result.due_date.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.days_since_last_maintenance is not none %}
                                        {{ "%.1f"|format(result.days_since_last_maintenance) }} days
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set existing_event = asset_event_map.get(result.asset_id) %}
                                    {% if existing_event %}
                                        <span class="badge bg-info">
                                            Event #{{ existing_event.id }} - {{ existing_event.status }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">No Event</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set existing_event = asset_event_map.get(result.asset_id) %}
                                    {% if existing_event %}
                                        <span class="text-muted">
                                            Event ID: <code>{{ existing_event.id }}</code>
                                        </span>
                                    {% else %}
                                        <form method="POST" action="{{ url_for('maintenance_plan.create_maintenance_event', plan_id=plan.id) }}" style="display: inline;">
                                            <input type="hidden" name="asset_id" value="{{ result.asset_id }}">
                                            <button type="submit" class="btn btn-sm btn-primary">
                                                <i class="bi bi-plus-circle"></i> Create Event
                                            </button>
                                        </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No assets currently need maintenance for this plan.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Additional Information -->
{% if results %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Planning Details</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-0">
                    <small>
                        Showing {{ results|length }} asset(s) that need maintenance.
                    </small>
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

