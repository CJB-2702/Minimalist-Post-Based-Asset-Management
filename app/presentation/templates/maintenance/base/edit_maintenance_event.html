{% extends "base.html" %}

{% block title %}Edit Maintenance Event - {{ maintenance.task_name }}{% endblock %}

{% block extra_css %}
<style>
    .event-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .action-card {
        transition: all 0.3s ease;
        border-left: 4px solid #dee2e6;
    }
    .action-card.not-started {
        border-left-color: #6c757d;
    }
    .action-card.in-progress {
        border-left-color: #0dcaf0;
        background-color: #f0f9ff;
    }
    .action-card.completed {
        border-left-color: #198754;
        background-color: #f0fdf4;
    }
    .detail-row {
        border-bottom: 1px solid #e9ecef;
        padding: 0.5rem 0;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
    .action-item {
        transition: all 0.2s ease;
    }
    .action-item:hover {
        background-color: #e9ecef;
        cursor: pointer;
    }
    .action-item.selected {
        background-color: #cfe2ff;
        border-left: 4px solid #0d6efd;
    }
    /* Responsive borders for Action Editor Panel */
    @media (min-width: 992px) {
        .action-editor-panel .border-responsive {
            border-right: 1px solid #dee2e6 !important;
            border-bottom: none !important;
        }
    }
    @media (max-width: 991.98px) {
        .action-editor-panel .border-responsive {
            border-right: none !important;
            border-bottom: 1px solid #dee2e6 !important;
        }
    }
    .comment-box {
        background-color: #f8f9fa;
        border-left: 3px solid #0d6efd;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.375rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% include 'maintenance/base/edit_maintenance_components/event_header.html' %}

    <!-- Upper Content Panels -->
    <div class="row mb-4">
        <!-- Left Panel: Maintenance Event Details + Blockers + Limitations -->
        <div class="col-lg-8 col-md-8">
            <div class="row">
                <!-- Event Details -->
                <div class="col-12">
                    {% include 'maintenance/base/edit_maintenance_components/event_details_form.html' %}
                </div>

                <!-- Blockers Card -->
                <div class="col-12">
                    {% include 'maintenance/base/edit_maintenance_components/blockers_card.html' %}
                </div>

                <!-- Limitations Card -->
                <div class="col-12">
                    {% include 'maintenance/base/edit_maintenance_components/limitations_card.html' %}
                </div>
            </div>
        </div>

        <!-- Right Panel: Quick Actions and Metadata -->
        <div class="col-lg-4 col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('maintenance_event_view.view_maintenance_event', event_id=event.id) }}" class="btn btn-outline-primary">
                            <i class="bi bi-eye"></i> View Event
                        </a>
                        <a href="{{ url_for('maintenance_event_work.work_maintenance_event', event_id=event.id) }}" class="btn btn-outline-success">
                            <i class="bi bi-tools"></i> Do Work
                        </a>
                        {% if active_blockers %}
                        <form method="POST" action="{{ url_for('maintenance.end_blocked_status', blocked_status_id=active_blockers[0].id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('End the blocked status and resume work?')">
                                <i class="bi bi-pause-circle"></i> End Blocked Status
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Metadata Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-database"></i> Metadata</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small">Event ID</label>
                        <p class="mb-0">{{ event.id }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">All Details ID</label>
                        <p class="mb-0">{{ maintenance.maintenance_action_set.all_details_id }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Asset</label>
                        <p class="mb-0">
                            {% if maintenance.asset %}
                                {{ maintenance.asset.name }}{% if maintenance.asset.serial_number %} (SN: {{ maintenance.asset.serial_number }}){% endif %} (ID: {{ maintenance.asset_id }})
                            {% else %}
                                None (ID: {{ maintenance.asset_id or 'N/A' }})
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Template Action Set</label>
                        <p class="mb-0">
                            {% if maintenance.maintenance_action_set.template_action_set %}
                                {{ maintenance.maintenance_action_set.template_action_set.task_name }}{% if maintenance.maintenance_action_set.template_action_set.revision %} (Rev. {{ maintenance.maintenance_action_set.template_action_set.revision }}){% endif %} (ID: {{ maintenance.maintenance_action_set.template_action_set_id }})
                            {% else %}
                                None (ID: {{ maintenance.maintenance_action_set.template_action_set_id or 'N/A' }})
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Maintenance Plan</label>
                        <p class="mb-0">
                            {% if maintenance.maintenance_action_set.maintenance_plan %}
                                {{ maintenance.maintenance_action_set.maintenance_plan.name }} (ID: {{ maintenance.maintenance_action_set.maintenance_plan_id }})
                            {% else %}
                                None (ID: {{ maintenance.maintenance_action_set.maintenance_plan_id or 'N/A' }})
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Meter Reading ID</label>
                        <p class="mb-0">
                            {% if maintenance.maintenance_action_set.meter_reading_id %}
                                <a href="{{ url_for('meter_history.list', asset_id=maintenance.asset_id) if maintenance.asset_id else '#' }}" 
                                   class="text-decoration-none">
                                    {{ maintenance.maintenance_action_set.meter_reading_id }}
                                    <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.75rem;"></i>
                                </a>
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </p>
                    </div>

                    <!-- Audit Information -->
                    <hr class="my-3">
                    <h6 class="mb-3 text-muted small"><i class="bi bi-info-circle"></i> Audit Information</h6>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Created At</label>
                        <p class="mb-0">
                            {% if maintenance.maintenance_action_set.created_at %}
                                {{ maintenance.maintenance_action_set.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Updated At</label>
                        <p class="mb-0">
                            {% if maintenance.maintenance_action_set.updated_at %}
                                {{ maintenance.maintenance_action_set.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Created By</label>
                        <p class="mb-0">
                            {% if maintenance.maintenance_action_set.created_by %}
                                {{ maintenance.maintenance_action_set.created_by.username }}
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Updated By</label>
                        <p class="mb-0">
                            {% if maintenance.maintenance_action_set.updated_by %}
                                {{ maintenance.maintenance_action_set.updated_by.username }}
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Part Demands Summary Card -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary bg-opacity-10">
                    <h5 class="mb-0">
                        <i class="bi bi-box-seam text-primary"></i> Part Demands Summary
                        {% if maintenance.part_demands %}
                        <span class="badge bg-primary ms-2">{{ maintenance.part_demands|length }}</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if maintenance.part_demands %}
                    <div class="list-group list-group-flush">
                        {% for part_demand in maintenance.part_demands[:10] %}
                        <div class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {% for action in actions %}
                                        {% if action.action_id == part_demand.action_id %}
                                        <span class="badge bg-secondary me-2">Action #{{ action.sequence_order }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    <strong>
                                        {% if part_demand.part %}
                                            {{ part_demand.part.part_name }}
                                        {% else %}
                                            Part #{{ part_demand.part_id }}
                                        {% endif %}
                                    </strong>
                                    <span class="text-muted ms-2">x {{ part_demand.quantity_required }} units</span>
                                </div>
                                <span class="badge bg-{% if part_demand.status == 'Issued' %}success{% elif part_demand.status == 'Rejected' or 'Cancelled' in part_demand.status %}danger{% elif 'Pending' in part_demand.status %}warning{% else %}secondary{% endif %}">
                                    {{ part_demand.status }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                        {% if maintenance.part_demands|length > 10 %}
                        <div class="list-group-item px-0 py-2 text-muted small">
                            ... and {{ maintenance.part_demands|length - 10 }} more
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0 small">No part demands yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Tools Summary Card -->
            <div class="card mb-4 border-info">
                <div class="card-header bg-info bg-opacity-10">
                    <h5 class="mb-0">
                        <i class="bi bi-tools text-info"></i> Tools Summary
                        {% if maintenance.action_tools %}
                        <span class="badge bg-info ms-2">{{ maintenance.action_tools|length }}</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if maintenance.action_tools %}
                    <div class="list-group list-group-flush">
                        {% for action_tool in maintenance.action_tools[:10] %}
                        <div class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {% for action in actions %}
                                        {% if action.action_id == action_tool.action_id %}
                                        <span class="badge bg-secondary me-2">Action #{{ action.sequence_order }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    <strong>
                                        {% if action_tool.tool %}
                                            {{ action_tool.tool.tool_name }}
                                        {% else %}
                                            Tool #{{ action_tool.tool_id }}
                                        {% endif %}
                                    </strong>
                                    {% if action_tool.tool and action_tool.tool.category %}
                                    <span class="text-muted ms-2 small">({{ action_tool.tool.category }})</span>
                                    {% endif %}
                                </div>
                                <span class="badge bg-{% if action_tool.status == 'Assigned' %}info{% elif action_tool.status == 'Returned' %}success{% elif action_tool.status == 'Missing' %}danger{% else %}secondary{% endif %}">
                                    {{ action_tool.status }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                        {% if maintenance.action_tools|length > 10 %}
                        <div class="list-group-item px-0 py-2 text-muted small">
                            ... and {{ maintenance.action_tools|length - 10 }} more
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0 small">No tools required yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ACTION EDITOR PANEL -->
    <div class="row">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> ACTION EDITOR PANEL</h5>
            </div>
            <div class="card-body p-0">
                <div class="row g-0 action-editor-panel" style="min-height: 500px;">
                    {% include 'maintenance/base/edit_maintenance_components/action_editor_panel/actions_list_sidebar.html' %}

                    {% include 'maintenance/base/edit_maintenance_components/action_editor_panel/action_edit_form.html' %}

                    <!-- Right Panel: Part Demands and Tools -->
                    <div class="col-lg-4 col-md-12">
                        <div class="p-3">
                            {% if selected_action %}
                            {% include 'maintenance/base/edit_maintenance_components/action_editor_panel/part_demands_section.html' %}

                            {% include 'maintenance/base/edit_maintenance_components/action_editor_panel/tools_section.html' %}
                            {% else %}
                            <p class="text-muted">No actions available. Use the Action Creator Portal below to add actions.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Creator Portal -->
    <div class="row">
        <div class="col-12"
             id="action-creator-portal-container"
             hx-get="{{ url_for('action_creator_portal.action_creator_portal', maintenance_action_set_id=maintenance.id) }}"
             hx-trigger="load"
             hx-target="this"
             hx-select="#action-creator-portal-wrapper"
             hx-swap="outerHTML">
            <!-- Loading placeholder -->
            <div class="card mb-4 border-info">
                <div class="card-header bg-info bg-opacity-10">
                    <h5 class="mb-0">
                        <i class="bi bi-plus-circle text-info"></i> Action Creator Portal
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center py-4">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading Action Creator Portal...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Activity (Bottom of page) -->
    <div class="row">
        <div class="col-12">
            {% if event and event.id %}
            <div id="event-widget-container"
                 hx-get="{{ url_for('comments.event_widget', event_id=event.id) }}"
                 hx-trigger="load"
                 hx-target="#event-widget-container"
                 hx-swap="outerHTML">
                <div class="card mb-4">
                    <div class="card-body text-center text-muted">
                        <i class="bi bi-hourglass-split"></i> Loading event activity...
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% include 'maintenance/base/edit_maintenance_components/blocker_modals.html' %}

    {% include 'maintenance/base/edit_maintenance_components/limitation_modals.html' %}

    <!-- Assign Warning Modal -->
    <div class="modal fade" id="assignWarningModal" tabindex="-1" aria-labelledby="assignWarningModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning bg-opacity-10">
                    <h5 class="modal-title" id="assignWarningModalLabel">
                        <i class="bi bi-exclamation-triangle text-warning"></i> Assign Maintenance Event
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning" role="alert">
                        <strong>Warning:</strong> This will directly assign the event. If you are a technician looking to work on this event, 
                        please use the "Do Work" button instead. That portal provides proper work tracking and completion workflows.
                    </div>
                    <p>Are you sure you want to proceed to the assignment page?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a href="{{ url_for('maintenance_event_assign.assign_event', event_id=event.id) }}" class="btn btn-warning">
                        Proceed to Assignment
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('maintenance_event_edit.serve_edit_maintenance_js') }}"></script>
{% endblock %}
