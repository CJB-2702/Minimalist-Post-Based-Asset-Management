{% extends "base.html" %}

{% block title %}{{ maintenance.task_name }} - Perform Maintenance{% endblock %}

{% block extra_css %}
<style>
    .action-card {
        transition: all 0.3s ease;
        border-left: 4px solid #dee2e6;
    }
    
    .action-card.not-started {
        border-left-color: #6c757d;
    }
    
    .action-card.in-progress {
        border-left-color: #0dcaf0;
        background-color: #f0f9ff;
    }
    
    .action-card.completed {
        border-left-color: #198754;
        background-color: #f0fdf4;
    }
    
    .detail-row {
        border-bottom: 1px solid #e9ecef;
        padding: 0.5rem 0;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-tools text-success"></i> {{ maintenance.task_name or 'Perform Maintenance' }}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if asset %}
                        Asset: <a href="{{ url_for('core_assets.detail', asset_id=asset.id) }}">{{ asset.name }}</a>
                        {% if asset.serial_number %} ({{ asset.serial_number }}){% endif %}
                        {% else %}
                        No asset associated
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('maintenance_event_view.view_maintenance_event', event_id=event.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to View
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% include 'maintenance/base/work_maintenance_components/status_card.html' %}

    {% include 'maintenance/base/work_maintenance_components/active_blockers_card.html' %}

    {% include 'maintenance/base/work_maintenance_components/active_limitations_card.html' %}

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Maintenance Event Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Maintenance Event Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <strong>Task Name:</strong><br>
                                <span>{{ maintenance.task_name or 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Description:</strong><br>
                                <span>{{ maintenance.description or 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Asset:</strong><br>
                                {% if asset %}
                                <a href="{{ url_for('core_assets.detail', asset_id=asset.id) }}">
                                    {{ asset.name }}
                                </a>
                                {% if asset.serial_number %} ({{ asset.serial_number }}){% endif %}
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                            <div class="detail-row">
                                <strong>Template Source:</strong><br>
                                {% if maintenance.template_action_set %}
                                <span>{{ maintenance.template_action_set.task_name }}</span>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-row">
                                <strong>Planned Start:</strong><br>
                                <span>{{ maintenance.planned_start_datetime.strftime('%Y-%m-%d %H:%M') if maintenance.planned_start_datetime else 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Actual Start:</strong><br>
                                <span>{{ maintenance.maintenance_action_set.start_date.strftime('%Y-%m-%d %H:%M') if maintenance.maintenance_action_set.start_date else 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Actual End:</strong><br>
                                <span>{{ maintenance.maintenance_action_set.end_date.strftime('%Y-%m-%d %H:%M') if maintenance.maintenance_action_set.end_date else 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Estimated Duration:</strong><br>
                                <span>{{ maintenance.maintenance_action_set.estimated_duration }} hours</span>{% if maintenance.maintenance_action_set.estimated_duration %} <small class="text-muted">(estimated)</small>{% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if maintenance.maintenance_action_set.completion_notes %}
                    <div class="mt-3">
                        <strong>Completion Notes:</strong>
                        <p class="mb-0">{{ maintenance.maintenance_action_set.completion_notes }}</p>
                    </div>
                    {% endif %}
                    
                    {% if maintenance.maintenance_action_set.blocker_notes %}
                    <div class="mt-3">
                        <strong>Blocker Notes:</strong>
                        <p class="mb-0 text-warning">{{ maintenance.maintenance_action_set.blocker_notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions List -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-check"></i> Maintenance Actions ({{ actions|length }})</h5>
                </div>
                <div class="card-body">
                    {% if actions %}
                    <div class="list-group list-group-flush">
                        {% for action_struct in actions %}
                        {% set action = action_struct.action %}
                        <div class="list-group-item action-card px-0 py-3 {{ action.status|lower|replace(' ', '-') }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0 me-2">
                                            <span class="badge bg-secondary me-2">#{{ action.sequence_order }}</span>
                                            {{ action.action_name }}
                                        </h6>
                                        <span class="badge bg-{% if action.status == 'Complete' %}success{% elif action.status == 'In Progress' %}primary{% elif action.status == 'Delayed' %}danger{% else %}secondary{% endif %}">
                                            {{ action.status }}
                                        </span>
                                    </div>
                                    
                                    {% if action.description %}
                                    <p class="text-muted small mb-2">{{ action.description }}</p>
                                    {% endif %}
                                    
                                    <div class="row g-2 mb-2">
                                        {% if action.estimated_duration %}
                                        <div class="col-auto">
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i> Est: {{ action.estimated_duration }}h
                                            </small>
                                        </div>
                                        {% endif %}
                                        {% if action.start_time %}
                                        <div class="col-auto">
                                            <small class="text-muted">
                                                <i class="bi bi-play-circle"></i> Started: {{ action.start_time.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </div>
                                        {% endif %}
                                        {% if action.end_time %}
                                        <div class="col-auto">
                                            <small class="text-muted">
                                                <i class="bi bi-check-circle"></i> Ended: {{ action.end_time.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    {% if action.safety_notes %}
                                    <div class="alert alert-warning py-2 px-3 mb-2">
                                        <small><strong><i class="bi bi-exclamation-triangle"></i> Safety Notes:</strong> {{ action.safety_notes }}</small>
                                    </div>
                                    {% endif %}
                                    
                                    {% if action.completion_notes %}
                                    <div class="mb-2">
                                        <small class="text-success"><strong>Completion Notes:</strong> {{ action.completion_notes }}</small>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Part Demands for this action -->
                                    {% if action_struct.part_demands %}
                                    <div class="card mt-3 border-info">
                                        <div class="card-header bg-info bg-opacity-10 py-2">
                                            <small class="fw-bold text-info">
                                                <i class="bi bi-box-seam"></i> Parts Required
                                            </small>
                                        </div>
                                        <div class="card-body py-2">
                                            {% for part_demand in action_struct.part_demands %}
                                            <div class="d-flex justify-content-between align-items-center mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                                                <div>
                                                    <span class="badge bg-{% if part_demand.status == 'Issued' %}success{% elif part_demand.status in ['Pending Manager Approval', 'Pending Inventory Approval', 'Ordered', 'Backordered'] %}warning{% elif part_demand.status in ['Rejected', 'Cancelled by Technician', 'Cancelled by Supply'] %}danger{% else %}info{% endif %}">
                                                        {% if part_demand.part %}
                                                            {{ part_demand.part.part_name }}
                                                        {% else %}
                                                            Part #{{ part_demand.part_id }}
                                                        {% endif %}
                                                        x{{ part_demand.quantity_required }}
                                                    </span>
                                                    <span class="badge bg-secondary ms-1">{{ part_demand.status }}</span>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    {% if part_demand.status in ['Cancelled by Technician', 'Cancelled by Supply'] %}
                                                    <form method="POST" action="{{ url_for('maintenance.undo_part_demand', part_demand_id=part_demand.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                        <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Reset this part demand back to planned?')">
                                                            <i class="bi bi-arrow-counterclockwise"></i> Undo
                                                        </button>
                                                    </form>
                                                    {% elif part_demand.status != 'Issued' %}
                                                    <form method="POST" action="{{ url_for('maintenance.issue_part_demand', part_demand_id=part_demand.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                        <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Issue this part?')">
                                                            <i class="bi bi-check"></i> Issue
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                    {% if part_demand.status not in ['Issued', 'Cancelled by Technician', 'Cancelled by Supply'] %}
                                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#cancelPartDemandModal"
                                                            data-part-demand-id="{{ part_demand.id }}"
                                                            data-part-name="{% if part_demand.part %}{{ part_demand.part.part_name }}{% else %}Part #{{ part_demand.part_id }}{% endif %}"
                                                            data-quantity="{{ part_demand.quantity_required }}">
                                                        <i class="bi bi-x"></i> Cancel
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="ms-3 text-end">
                                    <div class="btn-group-vertical" role="group">
                                        {% if action.status == 'Not Started' %}
                                        <button type="button" class="btn btn-sm btn-info mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal" 
                                                data-action-id="{{ action.id }}" 
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="In Progress">
                                            <i class="bi bi-play-circle"></i> Start
                                        </button>
                                        {% endif %}
                                        
                                        {% if action.status == 'In Progress' %}
                                        <button type="button" class="btn btn-sm btn-success mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="Complete">
                                            <i class="bi bi-check-circle"></i> Complete
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="Failed">
                                            <i class="bi bi-x-circle"></i> Failed
                                        </button>
                                        <button type="button" class="btn btn-sm btn-warning mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="Blocked">
                                            <i class="bi bi-exclamation-triangle"></i> Blocked
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="Skipped">
                                            <i class="bi bi-skip-forward"></i> Skip
                                        </button>
                                        {% endif %}
                                        
                                        {% if action.status == 'Blocked' %}
                                        <button type="button" class="btn btn-sm btn-info mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="In Progress">
                                            <i class="bi bi-arrow-repeat"></i> Resume
                                        </button>
                                        {% endif %}
                                        
                                        {% if action.status in ['Complete', 'Failed'] %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="{% if action.status == 'Complete' %}Failed{% else %}Complete{% endif %}">
                                            <i class="bi bi-arrow-left-right"></i> Change
                                        </button>
                                        {% endif %}
                                        
                                        <button type="button" class="btn btn-sm btn-outline-primary mb-1" data-bs-toggle="modal" data-bs-target="#editActionModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-maintenance-action-set-id="{{ action.maintenance_action_set_id }}"
                                                data-template-action-item-id="{{ action.template_action_item_id or '' }}"
                                                data-assigned-by-id="{{ action.assigned_by_id or '' }}"
                                                data-sequence-order="{{ action.sequence_order }}"
                                                data-action-name-val="{{ action.action_name }}"
                                                data-description="{{ action.description or '' }}"
                                                data-scheduled-start-time="{% if action.scheduled_start_time %}{{ action.scheduled_start_time.strftime('%Y-%m-%dT%H:%M') }}{% endif %}"
                                                data-start-time="{% if action.start_time %}{{ action.start_time.strftime('%Y-%m-%dT%H:%M') }}{% endif %}"
                                                data-end-time="{% if action.end_time %}{{ action.end_time.strftime('%Y-%m-%dT%H:%M') }}{% endif %}"
                                                data-billable-hours="{{ action.billable_hours or '' }}"
                                                data-estimated-duration="{{ action.estimated_duration or '' }}"
                                                data-expected-billable-hours="{{ action.expected_billable_hours or '' }}"
                                                data-completion-notes="{{ action.completion_notes or '' }}"
                                                data-safety-notes="{{ action.safety_notes or '' }}"
                                                data-notes="{{ action.notes or '' }}"
                                                data-assigned-user-id="{{ action.assigned_user_id or '' }}"
                                                data-created-at="{% if action.created_at %}{{ action.created_at.strftime('%Y-%m-%d %H:%M:%S') }}{% endif %}"
                                                data-updated-at="{% if action.updated_at %}{{ action.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}{% endif %}">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        
                                        <button type="button" class="btn btn-sm btn-outline-info mb-1" data-bs-toggle="modal" data-bs-target="#addPartDemandModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}">
                                            <i class="bi bi-plus-circle"></i> Add Part
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No actions defined for this maintenance event.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Event Activity Widget -->
            {% if event and event.id %}
            <div id="event-widget-container"
                 hx-get="{{ url_for('comments.event_widget', event_id=event.id) }}"
                 hx-trigger="load"
                 hx-target="#event-widget-container"
                 hx-swap="outerHTML">
                <div class="card mb-4">
                    <div class="card-body text-center text-muted">
                        <i class="bi bi-hourglass-split"></i> Loading event activity...
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('maintenance_event_view.view_maintenance_event', event_id=event.id) }}" class="btn btn-outline-primary">
                            <i class="bi bi-eye"></i> View Event
                        </a>
                        <a href="{{ url_for('maintenance_event_edit.render_edit_page', event_id=event.id) }}" class="btn btn-outline-warning">
                            <i class="bi bi-pencil"></i> Edit Event
                        </a>
                    </div>
                </div>
            </div>

            <!-- Event Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Event Information</h5>
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <strong>Status:</strong><br>
                        <span class="badge bg-{% if maintenance.status == 'Complete' %}success{% elif maintenance.status == 'In Progress' %}primary{% elif maintenance.status == 'Delayed' %}danger{% else %}secondary{% endif %}">
                            {{ maintenance.status }}
                        </span>
                    </div>
                    <div class="detail-row">
                        <strong>Priority:</strong><br>
                        <span class="badge bg-{% if maintenance.priority == 'Critical' %}danger{% elif maintenance.priority == 'High' %}warning{% elif maintenance.priority == 'Medium' %}info{% else %}secondary{% endif %}">
                            {{ maintenance.priority }}
                        </span>
                    </div>
                    <div class="detail-row">
                        <strong>Planned Start:</strong><br>
                        <span>{{ maintenance.planned_start_datetime.strftime('%Y-%m-%d %H:%M') if maintenance.planned_start_datetime else 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                        <strong>Actual Start:</strong><br>
                        <span>{{ maintenance.maintenance_action_set.start_date.strftime('%Y-%m-%d %H:%M') if maintenance.maintenance_action_set.start_date else 'Not started' }}</span>
                    </div>
                    {% if maintenance.maintenance_action_set.end_date %}
                    <div class="detail-row">
                        <strong>Completed:</strong><br>
                        <span>{{ maintenance.maintenance_action_set.end_date.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    {% endif %}
                    {% if maintenance.maintenance_action_set.estimated_duration %}
                    <div class="detail-row">
                        <strong>Estimated Duration:</strong><br>
                        <span>{{ maintenance.maintenance_action_set.estimated_duration }} hours</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Summary</h5>
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <strong>Total Actions:</strong> {{ actions|length }}
                    </div>
                    <div class="detail-row">
                        <strong>Completed:</strong> {{ actions|selectattr('action.status', 'equalto', 'Complete')|list|length }}
                    </div>
                    <div class="detail-row">
                        <strong>In Progress:</strong> {{ actions|selectattr('action.status', 'equalto', 'In Progress')|list|length }}
                    </div>
                    <div class="detail-row">
                        <strong>Total Parts:</strong> {{ maintenance.part_demands|default([])|length }}
                    </div>
                    <div class="detail-row">
                        <strong>Total Tools:</strong> {{ maintenance.action_tools|default([])|length }}
                    </div>
                    {% if maintenance.maintenance_action_set.actual_billable_hours %}
                    <div class="detail-row">
                        <strong>Billable Hours:</strong> {{ "%.2f"|format(maintenance.maintenance_action_set.actual_billable_hours) }}h
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Part Demands Card -->
            <div class="card mb-4 border-info">
                <div class="card-header bg-info bg-opacity-10">
                    <h5 class="mb-0">
                        <i class="bi bi-box-seam text-info"></i> 
                        Part Demands
                        <span class="badge bg-info ms-2">{{ maintenance.part_demands|default([])|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if maintenance.part_demands %}
                        {% for part_demand in maintenance.part_demands %}
                        <div class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="mb-1">
                                        <span class="badge bg-{% if part_demand.status == 'Issued' %}success{% elif part_demand.status in ['Pending Manager Approval', 'Pending Inventory Approval', 'Ordered', 'Backordered'] %}warning{% elif part_demand.status in ['Rejected', 'Cancelled by Technician', 'Cancelled by Supply'] %}danger{% else %}info{% endif %}">
                                            {% if part_demand.part %}
                                                {{ part_demand.part.part_name }}
                                            {% else %}
                                                Part #{{ part_demand.part_id }}
                                            {% endif %}
                                            x{{ part_demand.quantity_required }}
                                        </span>
                                        <span class="badge bg-secondary ms-1">{{ part_demand.status }}</span>
                                    </div>
                                    {% if part_demand.action %}
                                    <small class="text-muted">
                                        <i class="bi bi-list-check"></i> {{ part_demand.action.action_name }}
                                    </small>
                                    {% endif %}
                                </div>
                                <div class="btn-group btn-group-sm ms-2">
                                    {% if part_demand.status in ['Cancelled by Technician', 'Cancelled by Supply'] %}
                                    <form method="POST" action="{{ url_for('maintenance.undo_part_demand', part_demand_id=part_demand.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Reset this part demand back to planned?')" title="Undo Cancellation">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </form>
                                    {% elif part_demand.status != 'Issued' %}
                                    <form method="POST" action="{{ url_for('maintenance.issue_part_demand', part_demand_id=part_demand.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Issue this part?')" title="Issue Part">
                                            <i class="bi bi-check"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    {% if part_demand.status not in ['Issued', 'Cancelled by Technician', 'Cancelled by Supply'] %}
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#cancelPartDemandModal"
                                            data-part-demand-id="{{ part_demand.id }}"
                                            data-part-name="{% if part_demand.part %}{{ part_demand.part.part_name }}{% else %}Part #{{ part_demand.part_id }}{% endif %}"
                                            data-quantity="{{ part_demand.quantity_required }}"
                                            title="Cancel Part Demand">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0 small"><em>No part demands recorded</em></p>
                    {% endif %}
                </div>
            </div>

            <!-- Blockers Card -->
            <div class="card mb-4 {% if active_blockers %}border-warning{% else %}border-secondary{% endif %}">
                <div class="card-header {% if active_blockers %}bg-warning bg-opacity-10{% endif %}">
                    <h5 class="mb-0">
                        <i class="bi bi-{% if active_blockers %}exclamation-triangle text-warning{% else %}clock-history text-secondary{% endif %}"></i> 
                        Blockers ({{ blockers|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if blockers %}
                        {% for delay in blockers %}
                        <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <div>
                                    {% if delay.priority %}
                                    <span class="badge bg-{% if delay.priority == 'Critical' %}danger{% elif delay.priority == 'High' %}warning{% else %}info{% endif %}">
                                        {{ delay.priority }} Priority
                                    </span>
                                    {% endif %}
                                </div>
                                {% if not delay.end_date %}
                                <span class="badge bg-danger">Active</span>
                                {% else %}
                                <span class="badge bg-success">Closed</span>
                                {% endif %}
                            </div>
                            {% if delay.reason %}
                            <p class="small mb-1"><strong>Reason:</strong> {{ delay.reason }}</p>
                            {% endif %}
                            {% if delay.start_date %}
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> Started: {{ delay.start_date.strftime('%Y-%m-%d %H:%M') }}
                                {% if delay.end_date %}
                                <br><i class="bi bi-calendar-check"></i> Ended: {{ delay.end_date.strftime('%Y-%m-%d %H:%M') }}
                                {% endif %}
                            </small>
                            {% endif %}
                            {% if delay.notes %}
                            <p class="small text-muted mb-0 mt-1">{{ delay.notes }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0 small"><em>No blockers recorded</em></p>
                    {% endif %}
                </div>
            </div>

            <!-- Capability Limitations Card -->
            <div class="card mb-4 {% if active_limitations %}border-warning{% else %}border-secondary{% endif %}">
                <div class="card-header {% if active_limitations %}bg-warning bg-opacity-10{% endif %}">
                    <h5 class="mb-0">
                        <i class="bi bi-{% if active_limitations %}exclamation-diamond text-warning{% else %}clock-history text-secondary{% endif %}"></i> 
                        Capability Limitations ({{ limitation_records|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if limitation_records %}
                        {% for limitation in limitation_records %}
                        <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <div>
                                    <span class="badge bg-warning text-dark me-2">
                                        {{ limitation.status }}
                                    </span>
                                </div>
                                {% if limitation.is_active %}
                                <span class="badge bg-danger">Active</span>
                                {% else %}
                                <span class="badge bg-success">Closed</span>
                                {% endif %}
                            </div>
                            {% if limitation.limitation_description %}
                            <p class="small mb-1"><strong>Limitation:</strong> {{ limitation.limitation_description }}</p>
                            {% endif %}
                            {% if limitation.temporary_modifications %}
                            <p class="small mb-1 text-info"><strong>Modifications:</strong> {{ limitation.temporary_modifications }}</p>
                            {% endif %}
                            {% if limitation.start_time %}
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> Started: {{ limitation.start_time.strftime('%Y-%m-%d %H:%M') }}
                                {% if limitation.end_time %}
                                <br><i class="bi bi-calendar-check"></i> Ended: {{ limitation.end_time.strftime('%Y-%m-%d %H:%M') }}
                                {% endif %}
                            </small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0 small"><em>No capability limitations recorded</em></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>


{% include 'maintenance/base/work_maintenance_components/modals/action_status.html' %}
{% include 'maintenance/base/work_maintenance_components/modals/edit_action.html' %}
{% include 'maintenance/base/work_maintenance_components/modals/complete_maintenance.html' %}
{% include 'maintenance/base/work_maintenance_components/modals/create_blocked.html' %}
{% include 'maintenance/base/work_maintenance_components/modals/part_demand.html' %}
{% include 'maintenance/base/work_maintenance_components/modals/create_limitation.html' %}
{% include 'maintenance/base/work_maintenance_components/modals/close_limitation.html' %}



{% include 'maintenance/base/work_maintenance_components/scripts.html' %}
{% endblock %}
