{% extends "base.html" %}

{% block title %}{{ maintenance.task_name }} - Perform Maintenance{% endblock %}

{% block extra_css %}
<style>
    .action-card {
        transition: all 0.3s ease;
        border-left: 4px solid #dee2e6;
    }
    
    .action-card.not-started {
        border-left-color: #6c757d;
    }
    
    .action-card.in-progress {
        border-left-color: #0dcaf0;
        background-color: #f0f9ff;
    }
    
    .action-card.completed {
        border-left-color: #198754;
        background-color: #f0fdf4;
    }
    
    .detail-row {
        border-bottom: 1px solid #e9ecef;
        padding: 0.5rem 0;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-tools text-success"></i> {{ maintenance.task_name or 'Perform Maintenance' }}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if asset %}
                        Asset: <a href="{{ url_for('core_assets.detail', asset_id=asset.id) }}">{{ asset.name }}</a>
                        {% if asset.serial_number %} ({{ asset.serial_number }}){% endif %}
                        {% else %}
                        No asset associated
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('maintenance_event.view_maintenance_event', event_id=event.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to View
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% include 'maintenance/base/work_maintenance_components/status_card.html' %}

    {% include 'maintenance/base/work_maintenance_components/active_blockers_card.html' %}

    {% include 'maintenance/base/work_maintenance_components/active_limitations_card.html' %}

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Maintenance Event Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Maintenance Event Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <strong>Task Name:</strong><br>
                                <span>{{ maintenance.task_name or 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Description:</strong><br>
                                <span>{{ maintenance.description or 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Asset:</strong><br>
                                {% if asset %}
                                <a href="{{ url_for('core_assets.detail', asset_id=asset.id) }}">
                                    {{ asset.name }}
                                </a>
                                {% if asset.serial_number %} ({{ asset.serial_number }}){% endif %}
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                            <div class="detail-row">
                                <strong>Template Source:</strong><br>
                                {% if maintenance.template_action_set %}
                                <span>{{ maintenance.template_action_set.task_name }}</span>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-row">
                                <strong>Planned Start:</strong><br>
                                <span>{{ maintenance.planned_start_datetime.strftime('%Y-%m-%d %H:%M') if maintenance.planned_start_datetime else 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Actual Start:</strong><br>
                                <span>{{ maintenance.maintenance_action_set.start_date.strftime('%Y-%m-%d %H:%M') if maintenance.maintenance_action_set.start_date else 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Actual End:</strong><br>
                                <span>{{ maintenance.maintenance_action_set.end_date.strftime('%Y-%m-%d %H:%M') if maintenance.maintenance_action_set.end_date else 'N/A' }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Estimated Duration:</strong><br>
                                <span>{{ maintenance.maintenance_action_set.estimated_duration }} hours</span>{% if maintenance.maintenance_action_set.estimated_duration %} <small class="text-muted">(estimated)</small>{% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if maintenance.maintenance_action_set.completion_notes %}
                    <div class="mt-3">
                        <strong>Completion Notes:</strong>
                        <p class="mb-0">{{ maintenance.maintenance_action_set.completion_notes }}</p>
                    </div>
                    {% endif %}
                    
                    {% if maintenance.maintenance_action_set.blocker_notes %}
                    <div class="mt-3">
                        <strong>Blocker Notes:</strong>
                        <p class="mb-0 text-warning">{{ maintenance.maintenance_action_set.blocker_notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions List -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-check"></i> Maintenance Actions ({{ actions|length }})</h5>
                </div>
                <div class="card-body">
                    {% if actions %}
                    <div class="list-group list-group-flush">
                        {% for action_struct in actions %}
                        {% set action = action_struct.action %}
                        <div class="list-group-item action-card px-0 py-3 {{ action.status|lower|replace(' ', '-') }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0 me-2">
                                            <span class="badge bg-secondary me-2">#{{ action.sequence_order }}</span>
                                            {{ action.action_name }}
                                        </h6>
                                        <span class="badge bg-{% if action.status == 'Complete' %}success{% elif action.status == 'In Progress' %}primary{% elif action.status == 'Delayed' %}danger{% else %}secondary{% endif %}">
                                            {{ action.status }}
                                        </span>
                                    </div>
                                    
                                    {% if action.description %}
                                    <p class="text-muted small mb-2">{{ action.description }}</p>
                                    {% endif %}
                                    
                                    <div class="row g-2 mb-2">
                                        {% if action.estimated_duration %}
                                        <div class="col-auto">
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i> Est: {{ action.estimated_duration }}h
                                            </small>
                                        </div>
                                        {% endif %}
                                        {% if action.start_time %}
                                        <div class="col-auto">
                                            <small class="text-muted">
                                                <i class="bi bi-play-circle"></i> Started: {{ action.start_time.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </div>
                                        {% endif %}
                                        {% if action.end_time %}
                                        <div class="col-auto">
                                            <small class="text-muted">
                                                <i class="bi bi-check-circle"></i> Ended: {{ action.end_time.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    {% if action.safety_notes %}
                                    <div class="alert alert-warning py-2 px-3 mb-2">
                                        <small><strong><i class="bi bi-exclamation-triangle"></i> Safety Notes:</strong> {{ action.safety_notes }}</small>
                                    </div>
                                    {% endif %}
                                    
                                    {% if action.completion_notes %}
                                    <div class="mb-2">
                                        <small class="text-success"><strong>Completion Notes:</strong> {{ action.completion_notes }}</small>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Part Demands for this action -->
                                    {% if action_struct.part_demands %}
                                    <div class="card mt-3 border-info">
                                        <div class="card-header bg-info bg-opacity-10 py-2">
                                            <small class="fw-bold text-info">
                                                <i class="bi bi-box-seam"></i> Parts Required
                                            </small>
                                        </div>
                                        <div class="card-body py-2">
                                            {% for part_demand in action_struct.part_demands %}
                                            <div class="d-flex justify-content-between align-items-center mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                                                <div>
                                                    <span class="badge bg-{% if part_demand.status == 'Issued' %}success{% elif part_demand.status in ['Pending Manager Approval', 'Pending Inventory Approval', 'Ordered', 'Backordered'] %}warning{% elif part_demand.status in ['Rejected', 'Cancelled by Technician', 'Cancelled by Supply'] %}danger{% else %}info{% endif %}">
                                                        {% if part_demand.part %}
                                                            {{ part_demand.part.part_name }}
                                                        {% else %}
                                                            Part #{{ part_demand.part_id }}
                                                        {% endif %}
                                                        x{{ part_demand.quantity_required }}
                                                    </span>
                                                    <span class="badge bg-secondary ms-1">{{ part_demand.status }}</span>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    {% if part_demand.status in ['Cancelled by Technician', 'Cancelled by Supply'] %}
                                                    <form method="POST" action="{{ url_for('maintenance.undo_part_demand', part_demand_id=part_demand.id) }}" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Reset this part demand back to planned?')">
                                                            <i class="bi bi-arrow-counterclockwise"></i> Undo
                                                        </button>
                                                    </form>
                                                    {% elif part_demand.status != 'Issued' %}
                                                    <form method="POST" action="{{ url_for('maintenance.issue_part_demand', part_demand_id=part_demand.id) }}" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Issue this part?')">
                                                            <i class="bi bi-check"></i> Issue
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                    {% if part_demand.status not in ['Issued', 'Cancelled by Technician', 'Cancelled by Supply'] %}
                                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#cancelPartDemandModal"
                                                            data-part-demand-id="{{ part_demand.id }}"
                                                            data-part-name="{% if part_demand.part %}{{ part_demand.part.part_name }}{% else %}Part #{{ part_demand.part_id }}{% endif %}"
                                                            data-quantity="{{ part_demand.quantity_required }}">
                                                        <i class="bi bi-x"></i> Cancel
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="ms-3 text-end">
                                    <div class="btn-group-vertical" role="group">
                                        {% if action.status == 'Not Started' %}
                                        <button type="button" class="btn btn-sm btn-info mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal" 
                                                data-action-id="{{ action.id }}" 
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="In Progress">
                                            <i class="bi bi-play-circle"></i> Start
                                        </button>
                                        {% endif %}
                                        
                                        {% if action.status == 'In Progress' %}
                                        <button type="button" class="btn btn-sm btn-success mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="Complete">
                                            <i class="bi bi-check-circle"></i> Complete
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="Failed">
                                            <i class="bi bi-x-circle"></i> Failed
                                        </button>
                                        <button type="button" class="btn btn-sm btn-warning mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="Blocked">
                                            <i class="bi bi-exclamation-triangle"></i> Blocked
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="Skipped">
                                            <i class="bi bi-skip-forward"></i> Skip
                                        </button>
                                        {% endif %}
                                        
                                        {% if action.status == 'Blocked' %}
                                        <button type="button" class="btn btn-sm btn-info mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="In Progress">
                                            <i class="bi bi-arrow-repeat"></i> Resume
                                        </button>
                                        {% endif %}
                                        
                                        {% if action.status in ['Complete', 'Failed'] %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-1" data-bs-toggle="modal" data-bs-target="#actionStatusModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-target-status="{% if action.status == 'Complete' %}Failed{% else %}Complete{% endif %}">
                                            <i class="bi bi-arrow-left-right"></i> Change
                                        </button>
                                        {% endif %}
                                        
                                        <button type="button" class="btn btn-sm btn-outline-primary mb-1" data-bs-toggle="modal" data-bs-target="#editActionModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}"
                                                data-current-status="{{ action.status }}"
                                                data-maintenance-action-set-id="{{ action.maintenance_action_set_id }}"
                                                data-template-action-item-id="{{ action.template_action_item_id or '' }}"
                                                data-assigned-by-id="{{ action.assigned_by_id or '' }}"
                                                data-sequence-order="{{ action.sequence_order }}"
                                                data-action-name-val="{{ action.action_name }}"
                                                data-description="{{ action.description or '' }}"
                                                data-scheduled-start-time="{% if action.scheduled_start_time %}{{ action.scheduled_start_time.strftime('%Y-%m-%dT%H:%M') }}{% endif %}"
                                                data-start-time="{% if action.start_time %}{{ action.start_time.strftime('%Y-%m-%dT%H:%M') }}{% endif %}"
                                                data-end-time="{% if action.end_time %}{{ action.end_time.strftime('%Y-%m-%dT%H:%M') }}{% endif %}"
                                                data-billable-hours="{{ action.billable_hours or '' }}"
                                                data-estimated-duration="{{ action.estimated_duration or '' }}"
                                                data-expected-billable-hours="{{ action.expected_billable_hours or '' }}"
                                                data-completion-notes="{{ action.completion_notes or '' }}"
                                                data-safety-notes="{{ action.safety_notes or '' }}"
                                                data-notes="{{ action.notes or '' }}"
                                                data-assigned-user-id="{{ action.assigned_user_id or '' }}"
                                                data-created-at="{% if action.created_at %}{{ action.created_at.strftime('%Y-%m-%d %H:%M:%S') }}{% endif %}"
                                                data-updated-at="{% if action.updated_at %}{{ action.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}{% endif %}">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        
                                        <button type="button" class="btn btn-sm btn-outline-info mb-1" data-bs-toggle="modal" data-bs-target="#addPartDemandModal"
                                                data-action-id="{{ action.id }}"
                                                data-action-name="{{ action.action_name }}">
                                            <i class="bi bi-plus-circle"></i> Add Part
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No actions defined for this maintenance event.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Event Activity Widget -->
            {% if event and event.id %}
            <div id="event-widget-container"
                 hx-get="{{ url_for('comments.event_widget', event_id=event.id) }}"
                 hx-trigger="load"
                 hx-target="#event-widget-container"
                 hx-swap="outerHTML">
                <div class="card mb-4">
                    <div class="card-body text-center text-muted">
                        <i class="bi bi-hourglass-split"></i> Loading event activity...
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('maintenance_event.view_maintenance_event', event_id=event.id) }}" class="btn btn-outline-primary">
                            <i class="bi bi-eye"></i> View Event
                        </a>
                        <a href="{{ url_for('maintenance_event.render_edit_page', event_id=event.id) }}" class="btn btn-outline-warning">
                            <i class="bi bi-pencil"></i> Edit Event
                        </a>
                    </div>
                </div>
            </div>

            <!-- Event Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Event Information</h5>
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <strong>Status:</strong><br>
                        <span class="badge bg-{% if maintenance.status == 'Complete' %}success{% elif maintenance.status == 'In Progress' %}primary{% elif maintenance.status == 'Delayed' %}danger{% else %}secondary{% endif %}">
                            {{ maintenance.status }}
                        </span>
                    </div>
                    <div class="detail-row">
                        <strong>Priority:</strong><br>
                        <span class="badge bg-{% if maintenance.priority == 'Critical' %}danger{% elif maintenance.priority == 'High' %}warning{% elif maintenance.priority == 'Medium' %}info{% else %}secondary{% endif %}">
                            {{ maintenance.priority }}
                        </span>
                    </div>
                    <div class="detail-row">
                        <strong>Planned Start:</strong><br>
                        <span>{{ maintenance.planned_start_datetime.strftime('%Y-%m-%d %H:%M') if maintenance.planned_start_datetime else 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                        <strong>Actual Start:</strong><br>
                        <span>{{ maintenance.maintenance_action_set.start_date.strftime('%Y-%m-%d %H:%M') if maintenance.maintenance_action_set.start_date else 'Not started' }}</span>
                    </div>
                    {% if maintenance.maintenance_action_set.end_date %}
                    <div class="detail-row">
                        <strong>Completed:</strong><br>
                        <span>{{ maintenance.maintenance_action_set.end_date.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    {% endif %}
                    {% if maintenance.maintenance_action_set.estimated_duration %}
                    <div class="detail-row">
                        <strong>Estimated Duration:</strong><br>
                        <span>{{ maintenance.maintenance_action_set.estimated_duration }} hours</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Summary</h5>
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <strong>Total Actions:</strong> {{ actions|length }}
                    </div>
                    <div class="detail-row">
                        <strong>Completed:</strong> {{ actions|selectattr('action.status', 'equalto', 'Complete')|list|length }}
                    </div>
                    <div class="detail-row">
                        <strong>In Progress:</strong> {{ actions|selectattr('action.status', 'equalto', 'In Progress')|list|length }}
                    </div>
                    <div class="detail-row">
                        <strong>Total Parts:</strong> {{ maintenance.part_demands|default([])|length }}
                    </div>
                    <div class="detail-row">
                        <strong>Total Tools:</strong> {{ maintenance.action_tools|default([])|length }}
                    </div>
                    {% if maintenance.maintenance_action_set.actual_billable_hours %}
                    <div class="detail-row">
                        <strong>Billable Hours:</strong> {{ "%.2f"|format(maintenance.maintenance_action_set.actual_billable_hours) }}h
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Part Demands Card -->
            <div class="card mb-4 border-info">
                <div class="card-header bg-info bg-opacity-10">
                    <h5 class="mb-0">
                        <i class="bi bi-box-seam text-info"></i> 
                        Part Demands
                        <span class="badge bg-info ms-2">{{ maintenance.part_demands|default([])|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if maintenance.part_demands %}
                        {% for part_demand in maintenance.part_demands %}
                        <div class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="mb-1">
                                        <span class="badge bg-{% if part_demand.status == 'Issued' %}success{% elif part_demand.status in ['Pending Manager Approval', 'Pending Inventory Approval', 'Ordered', 'Backordered'] %}warning{% elif part_demand.status in ['Rejected', 'Cancelled by Technician', 'Cancelled by Supply'] %}danger{% else %}info{% endif %}">
                                            {% if part_demand.part %}
                                                {{ part_demand.part.part_name }}
                                            {% else %}
                                                Part #{{ part_demand.part_id }}
                                            {% endif %}
                                            x{{ part_demand.quantity_required }}
                                        </span>
                                        <span class="badge bg-secondary ms-1">{{ part_demand.status }}</span>
                                    </div>
                                    {% if part_demand.action %}
                                    <small class="text-muted">
                                        <i class="bi bi-list-check"></i> {{ part_demand.action.action_name }}
                                    </small>
                                    {% endif %}
                                </div>
                                <div class="btn-group btn-group-sm ms-2">
                                    {% if part_demand.status in ['Cancelled by Technician', 'Cancelled by Supply'] %}
                                    <form method="POST" action="{{ url_for('maintenance.undo_part_demand', part_demand_id=part_demand.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Reset this part demand back to planned?')" title="Undo Cancellation">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </form>
                                    {% elif part_demand.status != 'Issued' %}
                                    <form method="POST" action="{{ url_for('maintenance.issue_part_demand', part_demand_id=part_demand.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Issue this part?')" title="Issue Part">
                                            <i class="bi bi-check"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    {% if part_demand.status not in ['Issued', 'Cancelled by Technician', 'Cancelled by Supply'] %}
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#cancelPartDemandModal"
                                            data-part-demand-id="{{ part_demand.id }}"
                                            data-part-name="{% if part_demand.part %}{{ part_demand.part.part_name }}{% else %}Part #{{ part_demand.part_id }}{% endif %}"
                                            data-quantity="{{ part_demand.quantity_required }}"
                                            title="Cancel Part Demand">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0 small"><em>No part demands recorded</em></p>
                    {% endif %}
                </div>
            </div>

            <!-- Blockers Card -->
            <div class="card mb-4 {% if active_blockers %}border-warning{% else %}border-secondary{% endif %}">
                <div class="card-header {% if active_blockers %}bg-warning bg-opacity-10{% endif %}">
                    <h5 class="mb-0">
                        <i class="bi bi-{% if active_blockers %}exclamation-triangle text-warning{% else %}clock-history text-secondary{% endif %}"></i> 
                        Blockers ({{ blockers|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if blockers %}
                        {% for delay in blockers %}
                        <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <div>
                                    {% if delay.priority %}
                                    <span class="badge bg-{% if delay.priority == 'Critical' %}danger{% elif delay.priority == 'High' %}warning{% else %}info{% endif %}">
                                        {{ delay.priority }} Priority
                                    </span>
                                    {% endif %}
                                </div>
                                {% if not delay.end_date %}
                                <span class="badge bg-danger">Active</span>
                                {% else %}
                                <span class="badge bg-success">Closed</span>
                                {% endif %}
                            </div>
                            {% if delay.reason %}
                            <p class="small mb-1"><strong>Reason:</strong> {{ delay.reason }}</p>
                            {% endif %}
                            {% if delay.start_date %}
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> Started: {{ delay.start_date.strftime('%Y-%m-%d %H:%M') }}
                                {% if delay.end_date %}
                                <br><i class="bi bi-calendar-check"></i> Ended: {{ delay.end_date.strftime('%Y-%m-%d %H:%M') }}
                                {% endif %}
                            </small>
                            {% endif %}
                            {% if delay.notes %}
                            <p class="small text-muted mb-0 mt-1">{{ delay.notes }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0 small"><em>No blockers recorded</em></p>
                    {% endif %}
                </div>
            </div>

            <!-- Capability Limitations Card -->
            <div class="card mb-4 {% if active_limitations %}border-warning{% else %}border-secondary{% endif %}">
                <div class="card-header {% if active_limitations %}bg-warning bg-opacity-10{% endif %}">
                    <h5 class="mb-0">
                        <i class="bi bi-{% if active_limitations %}exclamation-diamond text-warning{% else %}clock-history text-secondary{% endif %}"></i> 
                        Capability Limitations ({{ limitation_records|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if limitation_records %}
                        {% for limitation in limitation_records %}
                        <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <div>
                                    <span class="badge bg-warning text-dark me-2">
                                        {{ limitation.status }}
                                    </span>
                                </div>
                                {% if limitation.is_active %}
                                <span class="badge bg-danger">Active</span>
                                {% else %}
                                <span class="badge bg-success">Closed</span>
                                {% endif %}
                            </div>
                            {% if limitation.limitation_description %}
                            <p class="small mb-1"><strong>Limitation:</strong> {{ limitation.limitation_description }}</p>
                            {% endif %}
                            {% if limitation.temporary_modifications %}
                            <p class="small mb-1 text-info"><strong>Modifications:</strong> {{ limitation.temporary_modifications }}</p>
                            {% endif %}
                            {% if limitation.start_time %}
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> Started: {{ limitation.start_time.strftime('%Y-%m-%d %H:%M') }}
                                {% if limitation.end_time %}
                                <br><i class="bi bi-calendar-check"></i> Ended: {{ limitation.end_time.strftime('%Y-%m-%d %H:%M') }}
                                {% endif %}
                            </small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0 small"><em>No capability limitations recorded</em></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Status Change Modal -->
<div class="modal fade" id="actionStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="" id="actionStatusForm">
                <div class="modal-header">
                    <h5 class="modal-title">Change Action Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="action_id" id="modalActionId">
                    <p>Action: <strong id="modalActionName"></strong></p>
                    <p>Current Status: <span class="badge bg-secondary" id="modalCurrentStatus"></span></p>
                    
                    <div class="mb-3">
                        <label for="modalTargetStatus" class="form-label">New Status <span class="text-danger">*</span></label>
                        <select class="form-select" id="modalTargetStatus" name="status" required>
                            <option value="">-- Select Status --</option>
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Complete">Complete</option>
                            <option value="Failed">Failed</option>
                            <option value="Skipped">Skipped</option>
                            <option value="Blocked">Blocked</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="commentSection">
                        <label for="statusComment" class="form-label">Comment <span class="text-danger" id="commentRequired">*</span></label>
                        <textarea class="form-control" id="statusComment" name="comment" rows="3"></textarea>
                        <input type="hidden" name="edited_comment" id="editedComment">
                        <small class="text-muted" id="commentHelp">You can edit this comment before submitting.</small>
                    </div>
                    
                    <!-- Part Demand Management for Complete -->
                    <div class="mb-3" id="completePartDemandsSection" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-info bg-opacity-10 py-2">
                                <small class="fw-bold text-info">
                                    <i class="bi bi-box-seam"></i> Part Demand Management
                                </small>
                            </div>
                            <div class="card-body py-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="issuePartDemands" name="issue_part_demands" value="true" checked>
                                    <label class="form-check-label" for="issuePartDemands">
                                        Automatically issue all non-issued part demands
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Part Demand Management for Failed/Skipped -->
                    <div class="mb-3" id="partDemandsSection" style="display: none;">
                        <div class="card border-warning">
                            <div class="card-header bg-warning bg-opacity-10 py-2">
                                <small class="fw-bold text-warning">
                                    <i class="bi bi-box-seam"></i> Part Demand Management
                                </small>
                            </div>
                            <div class="card-body py-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="part_demand_action" id="partDemandLeaveAsIs" value="leave_as_is" checked>
                                    <label class="form-check-label" for="partDemandLeaveAsIs">
                                        Leave part demands as is
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="part_demand_action" id="duplicatePartDemands" value="duplicate">
                                    <label class="form-check-label" for="duplicatePartDemands">
                                        Duplicate all part demands (parts may have been consumed during failure)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="part_demand_action" id="cancelPartDemands" value="cancel">
                                    <label class="form-check-label" for="cancelPartDemands">
                                        Cancel all non-issued part demands (task failed before start or was skipped)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="billableHoursSection">
                        <label for="statusBillableHours" class="form-label">Billable Hours</label>
                        <input type="number" step="any" min="0" class="form-control" id="statusBillableHours" name="billable_hours">
                    </div>
                    
                    <div class="mb-3" id="completionNotesSection">
                        <label for="statusCompletionNotes" class="form-label">Completion Notes</label>
                        <textarea class="form-control" id="statusCompletionNotes" name="completion_notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Action Modal -->
<div class="modal fade" id="editActionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="" id="editActionForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <input type="hidden" name="action_id" id="editActionId">
                    
                    <!-- Read-only metadata fields -->
                    <div class="card mb-3 bg-light">
                        <div class="card-header py-2">
                            <small class="fw-bold">Metadata (Read-only)</small>
                        </div>
                        <div class="card-body py-2">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label small">Action ID</label>
                                    <input type="text" class="form-control form-control-sm" id="editActionIdDisplay" disabled>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Maintenance Action Set ID</label>
                                    <input type="text" class="form-control form-control-sm" id="editMaintenanceActionSetId" name="maintenance_action_set_id" disabled>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Template Action Item ID</label>
                                    <input type="text" class="form-control form-control-sm" id="editTemplateActionItemId" 
                                           data-bs-toggle="tooltip" data-bs-placement="top" 
                                           title="Warning: Changing template action item ID may break template relationships" disabled>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Assigned By ID</label>
                                    <input type="text" class="form-control form-control-sm" id="editAssignedById" disabled>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Created At</label>
                                    <input type="text" class="form-control form-control-sm" id="editCreatedAt" disabled>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Updated At</label>
                                    <input type="text" class="form-control form-control-sm" id="editUpdatedAt" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Editable fields from VirtualActionItem and Action -->
                    <div class="mb-3">
                        <label for="editActionNameField" class="form-label">Action Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editActionNameField" name="action_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStatus" name="status">
                                <option value="Not Started">Not Started</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Complete">Complete</option>
                                <option value="Failed">Failed</option>
                                <option value="Skipped">Skipped</option>
                                <option value="Blocked">Blocked</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editSequenceOrder" class="form-label">Sequence Order</label>
                            <input type="number" min="1" class="form-control" id="editSequenceOrder" name="sequence_order">
                            <small class="text-muted">Changing this will reorder actions in the set</small>
                        </div>
                    </div>
                    
                    <!-- Reset to In Progress Option (for terminal states) -->
                    <div class="mb-3" id="resetToInProgressSection" style="display: none;">
                        <div class="alert alert-info">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="resetToInProgress" name="reset_to_in_progress" value="true">
                                <label class="form-check-label" for="resetToInProgress">
                                    <strong>Reset action to "In Progress"</strong> (for retry scenarios)
                                </label>
                            </div>
                            <small class="text-muted">This will change the action status from a terminal state back to "In Progress" to allow retry.</small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editScheduledStartTime" class="form-label">Scheduled Start Time</label>
                            <input type="datetime-local" class="form-control" id="editScheduledStartTime" name="scheduled_start_time">
                        </div>
                        <div class="col-md-6">
                            <label for="editStartTime" class="form-label">Start Time</label>
                            <input type="datetime-local" class="form-control" id="editStartTime" name="start_time">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editEndTime" class="form-label">End Time</label>
                            <input type="datetime-local" class="form-control" id="editEndTime" name="end_time">
                        </div>
                        <div class="col-md-6">
                            <label for="editAssignedUserId" class="form-label">Assigned User</label>
                            <select class="form-select" id="editAssignedUserId" name="assigned_user_id">
                                <option value="">Unassigned</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editEstimatedDuration" class="form-label">Estimated Duration (hours)</label>
                            <input type="number" min="0" class="form-control" id="editEstimatedDuration" name="estimated_duration">
                        </div>
                        <div class="col-md-6">
                            <label for="editExpectedBillableHours" class="form-label">Expected Billable Hours</label>
                            <input type="number" min="0" class="form-control" id="editExpectedBillableHours" name="expected_billable_hours">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editBillableHours" class="form-label">Billable Hours</label>
                        <input type="number" step="any" min="0" class="form-control" id="editBillableHours" name="billable_hours">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCompletionNotes" class="form-label">Completion Notes</label>
                        <textarea class="form-control" id="editCompletionNotes" name="completion_notes" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editSafetyNotes" class="form-label">Safety Notes</label>
                        <textarea class="form-control" id="editSafetyNotes" name="safety_notes" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Complete Maintenance Modal -->
<div class="modal fade" id="completeMaintenanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('maintenance_event.complete_maintenance', event_id=event.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Maintenance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="completionComment" class="form-label">Completion Comment <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="completionComment" name="completion_comment" rows="3" required></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="actualStartDate" class="form-label">Actual Start Date/Time <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="actualStartDate" name="actual_start_date" 
                                   value="{% if maintenance.maintenance_action_set.start_date %}{{ maintenance.maintenance_action_set.start_date.strftime('%Y-%m-%dT%H:%M') }}{% endif %}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="actualEndDate" class="form-label">Actual End Date/Time <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="actualEndDate" name="actual_end_date" 
                                   value="{% if maintenance.maintenance_action_set.end_date %}{{ maintenance.maintenance_action_set.end_date.strftime('%Y-%m-%dT%H:%M') }}{% endif %}" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="actualBillableHours" class="form-label">Actual Billable Hours <span class="text-danger">*</span></label>
                        <input type="number" step="any" min="0.2" class="form-control" id="actualBillableHours" name="actual_billable_hours" 
                               value="{% if maintenance_context.get_billable_hours_manager().actual_hours %}{{ maintenance_context.get_billable_hours_manager().actual_hours }}{% else %}{{ maintenance_context.get_billable_hours_manager().calculated_hours }}{% endif %}" required>
                        <small class="text-muted">Sum of action billable hours: 
                            {{ "%.2f"|format(maintenance_context.get_billable_hours_manager().calculated_hours) }}h
                        </small>
                    </div>
                    
                    <!-- Meter Verification Section -->
                    {% if asset %}
                    <hr>
                    <div class="mb-3">
                        <h6 class="mb-3">
                            <i class="bi bi-speedometer2"></i> Meter Verification <span class="text-danger">*</span>
                        </h6>
                        <div class="alert alert-info">
                            <small><i class="bi bi-info-circle"></i> Please verify or update the current meter readings for this asset.</small>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="meter1" class="form-label">Meter 1</label>
                                <input type="number" step="0.01" class="form-control meter-input" id="meter1" name="meter1" 
                                       value="{% if asset.meter1 is not none %}{{ asset.meter1 }}{% endif %}"
                                       placeholder="Enter meter 1 value">
                            </div>
                            <div class="col-md-6">
                                <label for="meter2" class="form-label">Meter 2</label>
                                <input type="number" step="0.01" class="form-control meter-input" id="meter2" name="meter2" 
                                       value="{% if asset.meter2 is not none %}{{ asset.meter2 }}{% endif %}"
                                       placeholder="Enter meter 2 value">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="meter3" class="form-label">Meter 3</label>
                                <input type="number" step="0.01" class="form-control meter-input" id="meter3" name="meter3" 
                                       value="{% if asset.meter3 is not none %}{{ asset.meter3 }}{% endif %}"
                                       placeholder="Enter meter 3 value">
                            </div>
                            <div class="col-md-6">
                                <label for="meter4" class="form-label">Meter 4</label>
                                <input type="number" step="0.01" class="form-control meter-input" id="meter4" name="meter4" 
                                       value="{% if asset.meter4 is not none %}{{ asset.meter4 }}{% endif %}"
                                       placeholder="Enter meter 4 value">
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="meterVerificationToggle" name="meter_verification_toggle" required>
                            <label class="form-check-label" for="meterVerificationToggle">
                                <strong>I confirm the meters are correct</strong>
                            </label>
                            <div class="form-text">This checkbox will be automatically checked if you modify any meter values.</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Complete Maintenance</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Blocked Status Modal -->
<div class="modal fade" id="createBlockedModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('maintenance_event.create_blocker', event_id=event.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Place in Blocked Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <small><i class="bi bi-info-circle"></i> Blockers pause maintenance work. If this blocker also affects asset capability, you can create a Capability Limitation record separately.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="blockerReason" class="form-label">Reason <span class="text-danger">*</span></label>
                        <select class="form-select" id="blockerReason" name="reason" required>
                            <option value="">-- Select Reason --</option>
                            {% for reason in allowable_reasons %}
                            <option value="{{ reason }}">{{ reason }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="blockerNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="blockerNotes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="blockerStartTime" class="form-label">Start Time</label>
                        <input type="datetime-local" 
                               class="form-control" 
                               id="blockerStartTime" 
                               name="start_time"
                               required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="blockerBillableHoursLost" class="form-label">Billable Hours Lost</label>
                        <input type="number" step="any" min="0" class="form-control" id="blockerBillableHoursLost" name="billable_hours_lost">
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventPriority" class="form-label">Update Event Priority</label>
                        <select class="form-select" id="eventPriority" name="event_priority">
                            <option value="">-- Keep Current Priority ({{ maintenance.priority }}) --</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                        <small class="form-text text-muted">Optionally update the maintenance event priority when creating this blocker</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="blockerComment" class="form-label">Comment to Add to Event</label>
                        <textarea class="form-control" id="blockerComment" name="comment_to_add_to_event" rows="2" placeholder="Optional comment to add to the event log"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Create Blocked Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Part Demand Modal -->
<div class="modal fade" id="addPartDemandModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="" id="addPartDemandForm">
                <div class="modal-header">
                    <h5 class="modal-title">Add Part Demand</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="action_id" id="partDemandActionId">
                    <p>Action: <strong id="partDemandActionName"></strong></p>
                    
                    <div class="mb-3">
                        <label for="partId" class="form-label">Part <span class="text-danger">*</span></label>
                        <select class="form-select" id="partId" name="part_id" required>
                            <option value="">-- Select Part --</option>
                            {% for part in parts %}
                            <option value="{{ part.id }}">{{ part.part_name }} ({{ part.part_number }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quantityRequired" class="form-label">Quantity Required <span class="text-danger">*</span></label>
                        <input type="number" step="any" min="0.1" class="form-control" id="quantityRequired" name="quantity_required" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="partDemandNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="partDemandNotes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Part Demand</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cancel Part Demand Modal -->
<div class="modal fade" id="cancelPartDemandModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="" id="cancelPartDemandForm">
                <div class="modal-header">
                    <h5 class="modal-title">Cancel Part Demand</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="part_demand_id" id="cancelPartDemandId">
                    <p>Part: <strong id="cancelPartName"></strong></p>
                    <p>Quantity: <strong id="cancelQuantity"></strong></p>
                    
                    <div class="mb-3">
                        <label for="cancellationComment" class="form-label">Cancellation Comment <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="cancellationComment" name="cancellation_comment" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Cancel Part Demand</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Capability Limitation Modal -->
<div class="modal fade" id="createLimitationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('maintenance.create_limitation', event_id=event.id) }}">
                <div class="modal-header bg-warning bg-opacity-10">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-diamond text-warning"></i> Add Asset Capability Limitation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <small><i class="bi bi-info-circle"></i> Use this to record when an asset has degraded operational capability, separate from maintenance progress blockers.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="limitationStatus" class="form-label">Capability Status <span class="text-danger">*</span></label>
                        <select class="form-select" id="limitationStatus" name="limitation_status" required>
                            <option value="">-- Select Status --</option>
                            {% for status in allowable_limitation_statuses %}
                            <option value="{{ status }}">{{ status }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Select the operational capability status of the asset</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="limitationDescription" class="form-label">Limitation Description</label>
                        <textarea class="form-control" id="limitationDescription" name="limitation_description" rows="3" placeholder="Describe what is limited or degraded"></textarea>
                        <small class="form-text text-muted">What exactly is limited or degraded?</small>
                    </div>
                    
                    <div class="mb-3" id="temporaryModificationsSection" style="display: none;">
                        <label for="temporaryModifications" class="form-label">Temporary Modifications <span class="text-danger" id="modificationsRequired">*</span></label>
                        <textarea class="form-control" id="temporaryModifications" name="temporary_modifications" rows="3" placeholder="Describe procedural, component, or safety compensations"></textarea>
                        <small class="form-text text-muted">
                            <strong>Required for Compensation statuses.</strong> Describe procedural, component, or safety compensations that allow the asset to operate.
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="limitationStartTime" class="form-label">Start Time <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control" id="limitationStartTime" name="start_time" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="limitationComment" class="form-label">Comment to Add to Event</label>
                        <textarea class="form-control" id="limitationComment" name="comment" rows="2" placeholder="Optional comment to add to the event log"></textarea>
                    </div>
                    
                    {% if active_blockers %}
                    <div class="mb-3">
                        <div class="card border-warning">
                            <div class="card-header bg-warning bg-opacity-10 py-2">
                                <small class="fw-bold text-warning">
                                    <i class="bi bi-link-45deg"></i> Link to Active Blocker
                                </small>
                            </div>
                            <div class="card-body py-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="linkToBlocker" name="link_to_blocker" value="true">
                                    <label class="form-check-label" for="linkToBlocker">
                                        Link this limitation to the current blocked status
                                    </label>
                                </div>
                                <small class="form-text text-muted">
                                    Active blocker: {{ active_blockers[0].reason }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Add Capability Limitation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Close Limitation Modal -->
{% if active_limitations %}
{% set limitation = active_limitations[0] %}
<div class="modal fade" id="closeLimitationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('maintenance.close_limitation', limitation_id=limitation.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Close Asset Capability Limitation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Status: <strong>{{ limitation.status }}</strong></p>
                    {% if asset %}
                    <p class="text-muted small">Closing this limitation will update the asset's capability status based on any remaining active limitations.</p>
                    {% endif %}
                    
                    {% if limitation.limitation_description %}
                    <div class="mb-3">
                        <p class="mb-0"><strong>Limitation:</strong></p>
                        <p class="text-muted">{{ limitation.limitation_description }}</p>
                    </div>
                    {% endif %}
                    
                    {% if limitation.temporary_modifications %}
                    <div class="mb-3">
                        <p class="mb-0"><strong>Temporary Modifications:</strong></p>
                        <p class="text-muted">{{ limitation.temporary_modifications }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="limitationStartTime" class="form-label">Start Time <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control" id="limitationStartTime" name="start_time" 
                               value="{{ limitation.start_time.strftime('%Y-%m-%dT%H:%M') if limitation.start_time else '' }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="limitationEndTime" class="form-label">End Time <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control" id="limitationEndTime" name="end_time" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="closeLimitationComment" class="form-label">Comment</label>
                        <textarea class="form-control" id="closeLimitationComment" name="comment" rows="3" placeholder="Optional comment about closing this limitation"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Close Limitation</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
// Action Status Modal Handler
document.getElementById('actionStatusModal').addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const actionId = button.getAttribute('data-action-id');
    const actionName = button.getAttribute('data-action-name');
    const currentStatus = button.getAttribute('data-current-status');
    const suggestedStatus = button.getAttribute('data-target-status') || ''; // Optional, for backward compatibility
    
    const modal = this;
    modal.querySelector('#modalActionId').value = actionId;
    modal.querySelector('#modalActionName').textContent = actionName;
    modal.querySelector('#modalCurrentStatus').textContent = currentStatus;
    
    const statusSelect = modal.querySelector('#modalTargetStatus');
    statusSelect.value = suggestedStatus; // Set suggested status if provided
    
    const form = modal.querySelector('#actionStatusForm');
    form.action = `/maintenance/action/${actionId}/update-status`;
    
    const commentSection = modal.querySelector('#commentSection');
    const commentRequired = modal.querySelector('#commentRequired');
    const commentHelp = modal.querySelector('#commentHelp');
    const commentField = modal.querySelector('#statusComment');
    const editedCommentField = modal.querySelector('#editedComment');
    
    // Store original generated comment for comparison
    let generatedComment = '';
    let isUserEdited = false;
    
    // Function to generate comment based on status transition
    function generateComment(fromStatus, toStatus) {
        const statusTransitions = {
            'Not Started -> In Progress': 'Action started',
            'In Progress -> Complete': 'Action completed successfully',
            'In Progress -> Failed': 'Action failed',
            'In Progress -> Blocked': 'Action blocked',
            'In Progress -> Skipped': 'Action skipped',
            'Blocked -> In Progress': 'Action resumed after being blocked',
            'Complete -> Failed': 'Action status changed from Complete to Failed',
            'Failed -> Complete': 'Action status changed from Failed to Complete',
            'Complete -> In Progress': 'Action reset to In Progress for retry',
            'Failed -> In Progress': 'Action reset to In Progress for retry',
            'Skipped -> In Progress': 'Action reset to In Progress',
        };
        
        const transitionKey = `${fromStatus} -> ${toStatus}`;
        return statusTransitions[transitionKey] || `Status changed from ${fromStatus} to ${toStatus}`;
    }
    
    // Function to update comment based on selected status
    function updateComment() {
        const selectedStatus = statusSelect.value;
        if (!selectedStatus) {
            commentField.value = '';
            generatedComment = '';
            editedCommentField.value = '';
            isUserEdited = false;
            return;
        }
        
        generatedComment = generateComment(currentStatus, selectedStatus);
        
        // Only update if user hasn't edited, or if they're changing the status again
        if (!isUserEdited || commentField.value === '') {
            commentField.value = generatedComment;
            editedCommentField.value = '';
        }
        
        // Check comment requirements
        const requiresComment = selectedStatus === 'Blocked' || selectedStatus === 'Failed' || 
                               (['Complete', 'Failed'].includes(currentStatus) && ['Complete', 'Failed'].includes(selectedStatus));
        
        if (requiresComment) {
            commentField.required = true;
            commentRequired.style.display = 'inline';
            commentHelp.textContent = 'A comment is required for this status change. You can edit it before submitting.';
        } else {
            commentField.required = false;
            commentRequired.style.display = 'none';
            commentHelp.textContent = 'You can add a comment (optional). If you edit it, it will be marked as human-created.';
        }
        
        // Show/hide part demand management section
        const partDemandsSection = modal.querySelector('#partDemandsSection');
        partDemandsSection.style.display = (selectedStatus === 'Failed' || selectedStatus === 'Skipped') ? 'block' : 'none';
        
        // Reset radio buttons when showing
        if (partDemandsSection.style.display === 'block') {
            modal.querySelector('#partDemandLeaveAsIs').checked = true;
        }
        
        // Show/hide complete part demands section
        const completeSection = modal.querySelector('#completePartDemandsSection');
        completeSection.style.display = selectedStatus === 'Complete' ? 'block' : 'none';
        
        // Show billable hours for completion states
        const billableSection = modal.querySelector('#billableHoursSection');
        billableSection.style.display = ['Complete', 'Failed'].includes(selectedStatus) ? 'block' : 'none';
        
        // Show completion notes for completion states
        const notesSection = modal.querySelector('#completionNotesSection');
        notesSection.style.display = ['Complete', 'Failed', 'Skipped'].includes(selectedStatus) ? 'block' : 'none';
    }
    
    // Track if comment is edited - use a single handler that checks the current generated comment
    function handleCommentInput() {
        if (this.value !== generatedComment && generatedComment !== '') {
            isUserEdited = true;
            editedCommentField.value = this.value;
        } else {
            isUserEdited = false;
            editedCommentField.value = '';
        }
    }
    
    // Remove any existing listeners and add new one
    commentField.removeEventListener('input', handleCommentInput);
    commentField.addEventListener('input', handleCommentInput);
    
    // Update comment when status changes
    statusSelect.removeEventListener('change', updateComment);
    statusSelect.addEventListener('change', updateComment);
    
    // Initialize on modal open
    commentField.value = '';
    generatedComment = '';
    editedCommentField.value = '';
    isUserEdited = false;
    
    // Generate comment if suggested status is provided
    if (suggestedStatus) {
        updateComment();
    }
});

// Edit Action Modal Handler
document.getElementById('editActionModal').addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const modal = this;
    
    // Get all data attributes
    const actionId = button.getAttribute('data-action-id');
    const actionName = button.getAttribute('data-action-name');
    const currentStatus = button.getAttribute('data-current-status');
    const maintenanceActionSetId = button.getAttribute('data-maintenance-action-set-id');
    const templateActionItemId = button.getAttribute('data-template-action-item-id');
    const assignedById = button.getAttribute('data-assigned-by-id');
    const sequenceOrder = button.getAttribute('data-sequence-order');
    const actionNameVal = button.getAttribute('data-action-name-val');
    const description = button.getAttribute('data-description');
    const scheduledStartTime = button.getAttribute('data-scheduled-start-time');
    const startTime = button.getAttribute('data-start-time');
    const endTime = button.getAttribute('data-end-time');
    const billableHours = button.getAttribute('data-billable-hours');
    const estimatedDuration = button.getAttribute('data-estimated-duration');
    const expectedBillableHours = button.getAttribute('data-expected-billable-hours');
    const completionNotes = button.getAttribute('data-completion-notes');
    const safetyNotes = button.getAttribute('data-safety-notes');
    const notes = button.getAttribute('data-notes');
    const assignedUserId = button.getAttribute('data-assigned-user-id');
    const createdAt = button.getAttribute('data-created-at');
    const updatedAt = button.getAttribute('data-updated-at');
    
    // Set hidden fields
    modal.querySelector('#editActionId').value = actionId;
    
    // Set read-only metadata fields
    modal.querySelector('#editActionIdDisplay').value = actionId;
    modal.querySelector('#editMaintenanceActionSetId').value = maintenanceActionSetId || '';
    modal.querySelector('#editTemplateActionItemId').value = templateActionItemId || '';
    modal.querySelector('#editAssignedById').value = assignedById || '';
    modal.querySelector('#editCreatedAt').value = createdAt || '';
    modal.querySelector('#editUpdatedAt').value = updatedAt || '';
    
    // Set editable fields
    modal.querySelector('#editActionNameField').value = actionNameVal || '';
    modal.querySelector('#editDescription').value = description || '';
    modal.querySelector('#editStatus').value = currentStatus || 'Not Started';
    modal.querySelector('#editSequenceOrder').value = sequenceOrder || '1';
    modal.querySelector('#editScheduledStartTime').value = scheduledStartTime || '';
    modal.querySelector('#editStartTime').value = startTime || '';
    modal.querySelector('#editEndTime').value = endTime || '';
    modal.querySelector('#editBillableHours').value = billableHours || '';
    modal.querySelector('#editEstimatedDuration').value = estimatedDuration || '';
    modal.querySelector('#editExpectedBillableHours').value = expectedBillableHours || '';
    modal.querySelector('#editCompletionNotes').value = completionNotes || '';
    modal.querySelector('#editSafetyNotes').value = safetyNotes || '';
    modal.querySelector('#editNotes').value = notes || '';
    modal.querySelector('#editAssignedUserId').value = assignedUserId || '';
    
    // Show/hide reset to In Progress option based on terminal states
    const terminalStates = ['Complete', 'Failed', 'Skipped'];
    const resetSection = modal.querySelector('#resetToInProgressSection');
    const resetCheckbox = modal.querySelector('#resetToInProgress');
    
    if (terminalStates.includes(currentStatus)) {
        resetSection.style.display = 'block';
        resetCheckbox.checked = false; // Reset checkbox
    } else {
        resetSection.style.display = 'none';
        resetCheckbox.checked = false;
    }
    
    // Initialize tooltip for template_action_item_id warning
    const templateIdField = modal.querySelector('#editTemplateActionItemId');
    if (templateIdField) {
        // Remove existing tooltip if any
        const existingTooltip = bootstrap.Tooltip.getInstance(templateIdField);
        if (existingTooltip) {
            existingTooltip.dispose();
        }
        // Initialize new tooltip
        new bootstrap.Tooltip(templateIdField);
    }
    
    // Set form action
    const form = modal.querySelector('#editActionForm');
    form.action = `/maintenance/action/${actionId}/update`;
});

// Add Part Demand Modal Handler
document.getElementById('addPartDemandModal').addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const actionId = button.getAttribute('data-action-id');
    const actionName = button.getAttribute('data-action-name');
    
    const modal = this;
    modal.querySelector('#partDemandActionId').value = actionId;
    modal.querySelector('#partDemandActionName').textContent = actionName;
    
    const form = modal.querySelector('#addPartDemandForm');
    form.action = `/maintenance/action/${actionId}/part-demand/create`;
});

// Meter Verification Toggle Handler
document.addEventListener('DOMContentLoaded', function() {
    const meterInputs = document.querySelectorAll('.meter-input');
    const verificationToggle = document.getElementById('meterVerificationToggle');
    
    if (meterInputs.length > 0 && verificationToggle) {
        // Store original values
        const originalValues = {};
        meterInputs.forEach(function(input) {
            originalValues[input.id] = input.value || '';
        });
        
        // Function to check if any meter has changed
        function checkMeterChanges() {
            let hasChanges = false;
            meterInputs.forEach(function(input) {
                const currentValue = input.value || '';
                const originalValue = originalValues[input.id] || '';
                if (currentValue !== originalValue) {
                    hasChanges = true;
                }
            });
            return hasChanges;
        }
        
        // Add event listeners to all meter inputs
        meterInputs.forEach(function(input) {
            input.addEventListener('input', function() {
                if (checkMeterChanges()) {
                    verificationToggle.checked = true;
                }
            });
            
            input.addEventListener('change', function() {
                if (checkMeterChanges()) {
                    verificationToggle.checked = true;
                }
            });
        });
    }
});

// Cancel Part Demand Modal Handler
document.getElementById('cancelPartDemandModal').addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const partDemandId = button.getAttribute('data-part-demand-id');
    const partName = button.getAttribute('data-part-name');
    const quantity = button.getAttribute('data-quantity');
    
    const modal = this;
    modal.querySelector('#cancelPartDemandId').value = partDemandId;
    modal.querySelector('#cancelPartName').textContent = partName;
    modal.querySelector('#cancelQuantity').textContent = quantity;
    
    const form = modal.querySelector('#cancelPartDemandForm');
    form.action = `/maintenance/part-demand/${partDemandId}/cancel`;
});

// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Set blocked status start time to now when create blocked modal opens
    const createBlockedModal = document.getElementById('createBlockedModal');
    if (createBlockedModal) {
        createBlockedModal.addEventListener('show.bs.modal', function () {
            const blockerStartTimeInput = document.getElementById('blockerStartTime');
            if (blockerStartTimeInput) {
                const now = new Date();
                // Format as YYYY-MM-DDTHH:mm for datetime-local input
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                blockerStartTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        });
    }
    
    // Handle Create Limitation Modal
    const createLimitationModal = document.getElementById('createLimitationModal');
    if (createLimitationModal) {
        createLimitationModal.addEventListener('show.bs.modal', function () {
            // Set start time to now
            const limitationStartTimeInput = document.getElementById('limitationStartTime');
            if (limitationStartTimeInput) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                limitationStartTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        });
        
        // Handle status change to show/hide temporary modifications field
        const statusSelect = document.getElementById('limitationStatus');
        const modificationsSection = document.getElementById('temporaryModificationsSection');
        const modificationsInput = document.getElementById('temporaryModifications');
        const modificationsRequired = document.getElementById('modificationsRequired');
        
        if (statusSelect && modificationsSection) {
            statusSelect.addEventListener('change', function() {
                const selectedStatus = this.value;
                const compensationStatuses = [
                    'Partially Mission Capable - Temporary Compensation',
                    'Fully Mission Capable - Temporary Compensation'
                ];
                
                if (compensationStatuses.includes(selectedStatus)) {
                    modificationsSection.style.display = 'block';
                    modificationsInput.required = true;
                    modificationsRequired.style.display = 'inline';
                } else {
                    modificationsSection.style.display = 'none';
                    modificationsInput.required = false;
                    modificationsRequired.style.display = 'none';
                    modificationsInput.value = '';  // Clear value when hidden
                }
            });
        }
    }
});

// Set end time to current time on page load
document.addEventListener('DOMContentLoaded', function() {
    const limitationEndTimeInput = document.getElementById('limitationEndTime');
    if (limitationEndTimeInput) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        limitationEndTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
});
</script>
{% endblock %}

